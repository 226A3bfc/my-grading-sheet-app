<!DOCTYPE html>
<html lang="th" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมบันทึกเกรด v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617; /* slate-950 */
            color: #e2e8f0; /* slate-200 */
        }
        .card {
            background-color: #0f172a; /* slate-900 */
            border: 1px solid #1e293b; /* slate-800 */
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        input, select {
            background-color: #1e293b; /* slate-800 */
            border: 1px solid #334155; /* slate-700 */
            color: #e2e8f0; /* slate-200 */
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
        }
        input:focus, select:focus {
            outline: 2px solid #4f46e5;
            outline-offset: 2px;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
        }
        input::placeholder { color: #94a3b8; /* slate-400 */ }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        .tab-button.active { background-color: #4f46e5; color: white; }
        .tab-button:not(.active) { background-color: #1e293b; color: #94a3b8; }

        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary .summary-arrow { transition: transform 0.2s; display: inline-block; }
        details[open] > summary .summary-arrow { transform: rotate(90deg); }

        .table-container::-webkit-scrollbar { height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #1e293b; }
        .table-container::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .sticky-col { position: sticky; left: 0; z-index: 10; background-color: #0f172a; }
        .sticky-header { position: sticky; top: 0; z-index: 20; background-color: #1e293b; }
        /* Ensure all cells in score table have borders */
        #score-input-table table, #score-input-table th, #score-input-table td {
            border: 1px solid #1e293b; /* slate-800 */
        }
        #score-input-table table {
            border-collapse: collapse; /* Ensure borders collapse */
        }
        #score-input-table thead th.sticky-col { z-index: 30; background-color: #1e293b;}

        .disabled-section { pointer-events: none; opacity: 0.5; position: relative; }
        .disabled-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(2, 6, 23, 0.7);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.1rem; color: #94a3b8;
            text-align: center; border-radius: 0.5rem; z-index: 40;
        }

        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: bottom 0.5s ease-in-out;
            z-index: 100;
        }
        #toast.show { bottom: 20px; }
        #toast.success { background-color: #10b981; }
        #toast.error { background-color: #ef4444; }
        #toast.info { background-color: #3b82f6; }


        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 100%; color: black; }
            .table-container { overflow: visible; }
            .print-bg-white { background-color: white !important; }
        }
    </style>
</head>
<body>

    <header class="max-w-7xl mx-auto mb-8 flex justify-between items-center print:hidden">
        <div class="flex items-center gap-4">
            <img id="school-logo" src="https://placehold.co/64x64/1e293b/e2e8f0?text=Logo" alt="School Logo" class="w-16 h-16 rounded-lg object-cover shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/64x64/1e293b/e2e8f0?text=Logo';">
            <div>
                <h1 class="text-3xl font-bold text-indigo-400">โปรแกรมบันทึกเกรด</h1>
                <p class="text-slate-400">เครื่องมือบันทึกเกรดแบบเรียลไทม์</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button id="how-to-use-button" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors flex items-center gap-2" onclick="showHowToUseModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                วิธีใช้งาน
            </button>
            <button id="reset-course-button" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors flex items-center gap-2" onclick="showResetConfirmationModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                รีเซ็ตคอร์ส
            </button>
            <button id="admin-view-button" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 bg-slate-800 hover:bg-slate-700 transition-colors" onclick="showAdminPasswordModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                </button>
            <button id="settings-button" class="p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 bg-slate-800 hover:bg-slate-700 transition-colors" onclick="showSettingsModal()">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l-.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </div>
    </header>

    <div class="max-w-7xl mx-auto space-y-8">
        <div class="p-6 rounded-lg card print:hidden">
            <h2 class="text-xl font-semibold mb-4">1. เลือกช่วงเวลาการศึกษา</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="select-academic-year" class="block text-sm font-medium text-slate-400 mb-1">ปีการศึกษา</label>
                    <select id="select-academic-year" class="p-2 w-full" onchange="updateAcademicYearSelection()"></select>
                </div>
                <div>
                    <label for="select-semester" class="block text-sm font-medium text-slate-400 mb-1">ภาคเรียน</label>
                    <select id="select-semester" class="p-2 w-full" onchange="updateSemesterSelection()"></select>
                </div>
            </div>
            <div id="academic-period-status" class="p-3 rounded-md text-center font-medium mt-4 hidden">กรุณาเลือกทั้งปีการศึกษาและภาคเรียน</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 print:hidden">
            <details class="p-6 rounded-lg card" open>
                <summary class="text-xl font-semibold cursor-pointer flex items-center gap-2">
                    <span class="summary-arrow">▶</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                    2. เลือกวิชา
                </summary>
                <div id="course-selection-section" class="mt-6 p-4 rounded-md border space-y-3 card disabled-section">
                    <div id="course-selection-overlay" class="disabled-overlay">
                        <span>กรุณาเลือกปีการศึกษาและภาคเรียนด้านบน</span>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div>
                            <label for="select-subject" class="block text-sm font-medium text-slate-400 mb-1">วิชา</label>
                            <select id="select-subject" class="p-2 w-full" onchange="updateCourseSelection()"></select>
                        </div>
                        <div>
                            <label for="select-grade-level" class="block text-sm font-medium text-slate-400 mb-1">ระดับชั้น</label>
                            <select id="select-grade-level" class="p-2 w-full" onchange="updateCourseSelection()"></select>
                        </div>
                        <div>
                            <label for="select-room" class="block text-sm font-medium text-slate-400 mb-1">ห้อง</label>
                            <select id="select-room" class="p-2 w-full" onchange="updateCourseSelection()">
                                <option value="">เลือกห้อง</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                            </select>
                        </div>
                    </div>
                    <div id="course-selection-status" class="p-3 rounded-md text-center font-medium hidden"></div>
                </div>
            </details>
            <details class="p-6 rounded-lg card" open>
                <summary class="text-xl font-semibold cursor-pointer flex items-center gap-2">
                    <span class="summary-arrow">▶</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    3. ข้อมูลครูผู้สอน
                </summary>
                <div id="teacher-info-container" class="mt-6 p-4 rounded-md border space-y-3 card disabled-section">
                    <div id="teacher-info-container-overlay" class="disabled-overlay">
                        <span>กรุณาเลือกวิชาด้านบน</span>
                    </div>
                    <div id="teacher-info-display" class="hidden">
                        <p class="text-lg font-semibold text-white" id="display-teacher-name"></p>
                        <p class="text-sm text-slate-400" id="display-teacher-id"></p>
                        <div class="flex gap-2 mt-3">
                            <button id="edit-teacher-info-button" class="bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700 transition-colors flex items-center justify-center gap-2" onclick="editTeacherInfo()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                แก้ไขข้อมูล
                            </button>
                            <button id="delete-teacher-info-button" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors flex items-center justify-center gap-2" onclick="showDeleteTeacherConfirmation()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                ลบข้อมูล
                            </button>
                        </div>
                    </div>
                    <div id="teacher-info-edit-form">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label for="teacher-real-name" class="block text-sm font-medium text-slate-400 mb-1">ชื่อ-นามสกุล <span class="text-red-500">*</span></label>
                                <input type="text" id="teacher-real-name" placeholder="ใส่ชื่อ-นามสกุลของคุณ" class="p-2 w-full teacher-info-input" oninput="checkTeacherFormValidity()">
                            </div>
                            <div>
                                <label for="teacher-id" class="block text-sm font-medium text-slate-400 mb-1">รหัสครู</label>
                                <input type="text" id="teacher-id" placeholder="ใส่รหัสครูของคุณ" class="p-2 w-full teacher-info-input">
                            </div>
                        </div>
                        <button id="save-teacher-info-button" onclick="saveTeacherInfo()" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 disabled:bg-indigo-800 disabled:text-slate-400 transition-colors flex items-center justify-center gap-2 mt-3" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            บันทึกข้อมูล
                        </button>
                        <p id="save-teacher-hint" class="text-sm text-yellow-400 mt-2 hidden text-center">
                            คลิก 'บันทึกข้อมูล' เพื่อปลดล็อกส่วนอื่นๆ
                        </p>
                    </div>
                </div>
            </details>
        </div>

        <div id="main-content-area" class="disabled-section">
            <div id="main-content-overlay" class="disabled-overlay">
                <span>กรุณาเลือก ปีการศึกษา, ภาคเรียน, และวิชา จากนั้นบันทึกข้อมูลครูผู้สอนเพื่อดำเนินการต่อ</span>
            </div>

            <details class="p-6 rounded-lg card" open>
                <summary class="text-xl font-semibold cursor-pointer flex items-center gap-2">
                    <span class="summary-arrow">▶</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                    4. ตั้งค่าองค์ประกอบการให้คะแนน
                </summary>
                <div class="mt-6">
                    <h3 class="font-semibold text-lg mb-3">1. จัดการองค์ประกอบการประเมิน (เช่น โครงการ, การนำเสนอ, สอบปลายภาค)</h3>
                    <div class="p-4 rounded-md border space-y-3 card">
                        <div id="grading-period-list" class="space-y-2"></div>
                        <div class="flex flex-col sm:flex-row gap-4 mt-3 border-t pt-4 border-slate-800">
                            <input type="text" id="new-grading-period-name" placeholder="ชื่อองค์ประกอบ (เช่น โครงการ)" class="flex-grow p-3">
                            <input type="number" id="new-grading-period-weight" placeholder="น้ำหนัก (%)" class="w-full sm:w-32 p-3">
                            <button onclick="addGradingPeriod()" class="bg-blue-600 text-white px-5 py-3 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                เพิ่มองค์ประกอบ
                            </button>
                        </div>
                        <div class="text-right mt-2">
                            <p id="total-grading-period-weight-info" class="font-medium">น้ำหนักรวม: <span id="current-total-grading-period-weight">0</span>%</p>
                            <p id="grading-period-warning" class="text-red-500 font-medium hidden">⚠️ น้ำหนักรวมขององค์ประกอบต้องเป็น 100%</p>
                        </div>
                    </div>

                    <h3 class="font-semibold text-lg mt-6 mb-3">2. เลือกองค์ประกอบเพื่อจัดการหมวดหมู่</h3>
                    <div class="p-4 rounded-md border space-y-3 card">
                        <select id="select-grading-period" class="p-2 w-full" onchange="selectGradingPeriod()">
                            <option value="">เลือกองค์ประกอบการประเมิน</option>
                        </select>
                        <div id="selected-grading-period-status" class="p-3 rounded-md text-center font-medium hidden"></div>
                    </div>

                    <h3 class="font-semibold text-lg mt-6 mb-3">3. จัดการหมวดหมู่ใน <span id="current-period-name" class="text-indigo-300">องค์ประกอบที่เลือก</span></h3>
                    <div id="category-management-section" class="disabled-section">
                        <div id="category-management-overlay" class="disabled-overlay">
                            <span>กรุณาเลือกองค์ประกอบการประเมินด้านบนเพื่อจัดการหมวดหมู่</span>
                        </div>
                        <div id="category-settings" class="space-y-4"></div>
                        <div class="flex flex-col sm:flex-row gap-4 mt-6 border-t pt-4 border-slate-800">
                            <input type="text" id="new-category-name" placeholder="ชื่อหมวดหมู่ใหม่ (เช่น การบ้าน)" class="flex-grow p-3">
                            <input type="number" id="new-category-weight" placeholder="น้ำหนัก (%)" class="w-full sm:w-32 p-3">
                            <button onclick="addCategory()" class="bg-blue-600 text-white px-5 py-3 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                เพิ่มหมวดหมู่
                            </button>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 mt-4">
                            <input type="file" id="category-csv-file-input" accept=".csv" class="hidden" onchange="handleCategoryCsvImport(event)">
                            <button onclick="document.getElementById('category-csv-file-input').click()" class="w-full bg-slate-700 text-slate-200 px-4 py-2 rounded-md hover:bg-slate-600 transition-colors flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                นำเข้าหมวดหมู่ (CSV)
                            </button>
                        </div>
                        <p class="text-sm text-slate-400 mt-2">รูปแบบ: `categoryName,weight` (เช่น `การมีส่วนร่วม,10`)</p>
                        <div class="text-right mt-2">
                            <p id="total-category-weight-info" class="font-medium">น้ำหนักรวมหมวดหมู่: <span id="current-total-category-weight">0</span>%</p>
                            <p id="category-weight-warning" class="text-red-500 font-medium hidden">⚠️ น้ำหนักรวมของหมวดหมู่ในองค์ประกอบนี้ต้องเป็น 100%</p>
                        </div>
                    </div>
                </div>
            </details>

            <details class="p-6 rounded-lg card" open>
                <summary class="text-xl font-semibold cursor-pointer flex items-center gap-2">
                    <span class="summary-arrow">▶</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    5. จัดการข้อมูลนักเรียน
                </summary>
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 rounded-md border space-y-3 card">
                        <h3 class="font-semibold text-lg">เพิ่มนักเรียนใหม่</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="new-student-real-name" placeholder="ชื่อ-นามสกุล" class="p-2 col-span-2 new-student-input" oninput="checkAddStudentFormValidity()">
                            <input type="text" id="new-student-nickname" placeholder="ชื่อเล่น" class="p-2 col-span-2 new-student-input">
                            <input type="text" id="new-student-id" placeholder="รหัสนักเรียน" class="p-2 new-student-input" oninput="checkAddStudentFormValidity()">
                            <input type="number" id="new-student-roll-number" placeholder="เลขที่" class="p-2 new-student-input" oninput="checkAddStudentFormValidity()">
                        </div>
                        <button id="add-student-button" onclick="addStudent()" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:bg-green-800 disabled:text-slate-400 transition-colors flex items-center justify-center gap-2" disabled>เพิ่มนักเรียน</button>
                    </div>
                    <div class="p-4 rounded-md border flex flex-col items-center justify-center text-center card">
                        <h3 class="font-semibold text-lg">นำเข้าจากไฟล์ CSV</h3>
                        <p class="text-sm text-slate-400 my-2">รูปแบบ: `studentId,realName,nickname,rollNumber`</p>
                        <p class="text-sm text-slate-400 my-2">(ระดับชั้นและห้องจะอิงจากที่เลือกปัจจุบัน)</p>
                        <input type="file" id="csv-file-input" accept=".csv" class="hidden" onchange="handleCsvImport(event)">
                        <button onclick="document.getElementById('csv-file-input').click()" class="w-full bg-slate-700 text-slate-200 px-4 py-2 rounded-md hover:bg-slate-600 transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            เลือกไฟล์ .csv
                        </button>
                    </div>
                </div>
                <div id="student-list" class="mt-6 space-y-2"></div>
            </details>

            <div id="printable-area" class="print-bg-white">
                <div class="flex justify-center border-b border-slate-800 mb-6 print:hidden">
                    <button id="score-entry-tab" class="tab-button active px-6 py-3 text-lg font-medium rounded-t-lg" onclick="showTab('score-entry')">บันทึกคะแนน ✏️</button>
                    <button id="summary-tab" class="tab-button px-6 py-3 text-lg font-medium rounded-t-lg" onclick="showTab('summary')">สรุปและรายงาน 🏆</button>
                </div>

                <div id="score-entry-section">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">กรอกคะแนนนักเรียน</h2>
                        <button onclick="window.print()" class="bg-slate-500 text-white px-4 py-2 rounded-md hover:bg-slate-600 transition-colors print:hidden flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                            พิมพ์ตาราง
                        </button>
                    </div>
                    <div id="score-input-table" class="table-container overflow-x-auto"></div>
                    <p id="score-entry-info" class="text-slate-400 mt-4 text-center hidden"></p>
                </div>

                <div id="summary-section" class="hidden">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h2 class="text-2xl font-semibold">สรุปและวิเคราะห์คะแนน</h2>
                        <div class="flex items-center gap-2">
                            <button onclick="exportScoresToCsv()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors print:hidden flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                ส่งออกเป็น CSV
                            </button>
                            <button onclick="window.print()" class="bg-slate-500 text-white px-4 py-2 rounded-md hover:bg-slate-600 transition-colors print:hidden flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                                พิมพ์รายงาน
                            </button>
                        </div>
                    </div>
                    <div id="advanced-dashboard" class="mb-8 p-6 rounded-lg shadow-inner border card print:hidden">
                        <h3 class="text-xl font-semibold mb-4">ภาพรวมผลการเรียนนักเรียน</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="relative h-80"><canvas id="student-group-chart"></canvas></div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="p-3 bg-green-900/50 rounded-lg">
                                    <h5 class="font-bold text-green-300 text-center">ยอดเยี่ยม (>=70%)</h5>
                                    <ul id="group-excellent" class="mt-2 text-sm text-green-400 list-disc list-inside"></ul>
                                </div>
                                <div class="p-3 bg-yellow-900/50 rounded-lg">
                                    <h5 class="font-bold text-yellow-300 text-center">ปานกลาง (50-69%)</h5>
                                    <ul id="group-average" class="mt-2 text-sm text-yellow-400 list-disc list-inside"></ul>
                                </div>
                                <div class="p-3 bg-red-900/50 rounded-lg">
                                    <h5 class="font-bold text-red-300 text-center">ต้องปรับปรุง (&lt;50%)</h5>
                                    <ul id="group-improvement" class="mt-2 text-sm text-red-400 list-disc list-inside"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="summary-table" class="table-container overflow-x-auto"></div>
                    <p id="summary-info" class="text-slate-400 mt-4 text-center"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="p-6 rounded-lg shadow-xl max-w-sm w-full card">
            <h3 id="alert-title" class="text-xl font-semibold mb-4">การแจ้งเตือน</h3>
            <p id="alert-message" class="mb-6 text-slate-300"></p>
            <div class="flex justify-end">
                <button onclick="hideAlert()" class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700">ตกลง</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="p-6 rounded-lg shadow-xl max-w-md w-full card">
            <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l-.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                ตั้งค่า
            </h3>
            <div class="space-y-4">
                <div>
                    <label for="settings-logo-url" class="block text-sm font-medium text-slate-400">URL โลโก้โรงเรียน</label>
                    <input type="url" id="settings-logo-url" placeholder="วาง URL รูปภาพที่นี่" class="mt-1 p-2 w-full">
                </div>
                <div>
                    <label for="settings-admin-token" class="block text-sm font-medium text-slate-400">Token ผู้ดูแลระบบ (Token ใหม่)</label>
                    <input type="text" id="settings-admin-token" placeholder="ใส่ Token สำหรับเข้าถึง Admin Dashboard" class="mt-1 p-2 w-full">
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="hideSettingsModal()" class="bg-slate-700 text-slate-200 px-4 py-2 rounded-md hover:bg-slate-600">ยกเลิก</button>
                <button id="save-settings-button" onclick="saveSettings()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">บันทึก</button>
            </div>
        </div>
    </div>

    <div id="admin-password-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="p-6 rounded-lg shadow-xl max-w-sm w-full card">
            <h3 class="text-xl font-semibold mb-4">การเข้าถึงผู้ดูแลระบบ</h3>
            <p class="text-slate-400 mb-4">กรุณาใส่ Token ผู้ดูแลระบบเพื่อเข้าสู่ Dashboard</p>
            <div>
                <label for="admin-password-input" class="block text-sm font-medium text-slate-400">Token</label>
                <input type="password" id="admin-password-input" class="mt-1 p-2 w-full">
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="hideAdminPasswordModal()" class="bg-slate-700 text-slate-200 px-4 py-2 rounded-md hover:bg-slate-600">ยกเลิก</button>
                <button onclick="checkAdminPassword()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">เข้าสู่ระบบ</button>
            </div>
        </div>
    </div>

    <div id="reset-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="p-6 rounded-lg shadow-xl max-w-sm w-full card">
            <h3 class="text-xl font-semibold mb-4 text-red-400">ยืนยันการรีเซ็ต</h3>
            <p class="text-slate-300 mb-4">การดำเนินการนี้จะล้างข้อมูลหมวดหมู่และข้อมูลครูผู้สอนทั้งหมดของวิชาที่เลือก และลบข้อมูลคะแนนของนักเรียนทั้งหมดสำหรับวิชานี้</p>
            <p class="text-slate-300 mb-4 font-bold">กรุณาใส่ Token การรีเซ็ตเพื่อยืนยัน:</p>
            <div>
                <label for="reset-password-input" class="block text-sm font-medium text-slate-400">Token</label>
                <input type="password" id="reset-password-input" class="mt-1 p-2 w-full" placeholder="ใส่ Token สำหรับการรีเซ็ต">
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="hideResetConfirmationModal()" class="bg-slate-700 text-slate-200 px-4 py-2 rounded-md hover:bg-slate-600">ยกเลิก</button>
                <button onclick="confirmResetCourse()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">ยืนยันการรีเซ็ต</button>
            </div>
        </div>
    </div>

    <div id="admin-dashboard-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="p-6 rounded-lg shadow-xl max-w-4xl w-full h-[90vh] flex flex-col card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">แดชบอร์ดผู้ดูแลระบบ: ภาพรวมทุกวิชา</h3>
                <button onclick="hideAdminDashboardModal()" class="text-slate-400 hover:text-white text-3xl font-bold">&times;</button>
            </div>
            <div id="admin-dashboard-content" class="flex-grow overflow-y-auto space-y-6">
                </div>
        </div>
    </div>

    <div id="score-breakdown-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="p-6 rounded-lg shadow-xl max-w-lg w-full card">
            <h3 id="score-breakdown-modal-title" class="text-xl font-semibold mb-4"></h3>
            <div id="score-breakdown-content" class="space-y-3 mb-6"></div>
            <div class="flex justify-end">
                <button onclick="hideScoreBreakdownModal()" class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700">ปิด</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="p-6 rounded-lg shadow-xl max-w-sm w-full card">
            <h3 id="confirmation-title" class="text-xl font-semibold mb-4 text-red-400">ยืนยันการดำเนินการ</h3>
            <p id="confirmation-message" class="mb-6 text-slate-300"></p>
            <div class="flex justify-end gap-2">
                <button onclick="hideConfirmationModal()" class="bg-slate-700 text-slate-200 px-4 py-2 rounded-md hover:bg-slate-600">ยกเลิก</button>
                <button id="confirm-action-button" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">ยืนยัน</button>
            </div>
        </div>
    </div>

    <div id="how-to-use-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="p-6 rounded-lg shadow-xl max-w-2xl w-full h-[90vh] flex flex-col card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">วิธีใช้งานโปรแกรมบันทึกเกรด</h3>
                <button onclick="hideHowToUseModal()" class="text-slate-400 hover:text-white text-3xl font-bold">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto text-slate-300 space-y-4">
                <p>ยินดีต้อนรับสู่โปรแกรมบันทึกเกรด! ทำตามขั้นตอนเหล่านี้เพื่อตั้งค่าวัดผลการเรียน จัดการข้อมูลนักเรียน กรอกคะแนน และดูรายงานสรุป</p>

                <h4 class="text-xl font-semibold text-indigo-400">คำแนะนำทีละขั้นตอน:</h4>

                <ol class="list-decimal list-inside space-y-3">
                    <li>
                        <p class="font-medium text-white"><strong>1. เลือกช่วงเวลาการศึกษา:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-sm">
                            <li>เลือก **ปีการศึกษา** และ **ภาคเรียน** (เทอม 1, เทอม 2, เทอม 3)</li>
                            <li><span class="text-red-400">ขั้นตอนนี้จำเป็นต้องทำก่อน.</span> ส่วนอื่นๆ ของแอปจะถูกปิดการใช้งานจนกว่าจะเลือกครบถ้วน</li>
                        </ul>
                    </li>
                    <li>
                        <p class="font-medium text-white"><strong>2. เลือกวิชา:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-sm">
                            <li>เลือก **วิชา**, **ระดับชั้น**, และ **ห้อง** สำหรับคอร์สของคุณ</li>
                            <li>หากเป็นการรวมกันของข้อมูลที่ไม่เคยมีมาก่อน ระบบจะสร้างคอร์สใหม่ให้ หากมีอยู่แล้ว ระบบจะโหลดข้อมูลที่มีอยู่</li>
                        </ul>
                    </li>
                    <li>
                        <p class="font-medium text-white"><strong>3. ข้อมูลครูผู้สอน:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-sm">
                            <li>ใส่ **ชื่อ-นามสกุล** (จำเป็น) และ **รหัสครู**</li>
                            <li>คลิก **"บันทึกข้อมูล"** เมื่อบันทึกแล้วแบบฟอร์มจะซ่อนลงไป และจะมีปุ่ม "แก้ไข" / "ลบ" ปรากฏขึ้นมา</li>
                            <li>คุณยังสามารถตั้ง **URL โลโก้โรงเรียน** ได้ในหน้าต่างการตั้งค่า (ไอคอนฟันเฟืองมุมบนขวา)</li>
                        </ul>
                    </li>
                    <li>
                        <p class="font-medium text-white"><strong>4. ตั้งค่าองค์ประกอบการให้คะแนน:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-sm">
                            <li><strong>จัดการองค์ประกอบการประเมิน:</strong> เพิ่มองค์ประกอบหลัก (เช่น "สอบกลางภาค", "โครงงาน") พร้อมน้ำหนักรวม (เช่น 30%, 70%) น้ำหนักรวมของทุกองค์ประกอบต้องเป็น 100%</li>
                            <li><strong>เลือกองค์ประกอบเพื่อจัดการหมวดหมู่:</strong> เลือกหนึ่งในองค์ประกอบหลักของคุณเพื่อกำหนดหมวดหมู่ย่อย</li>
                            <li><strong>จัดการหมวดหมู่ใน [องค์ประกอบที่เลือก]:</strong> เพิ่ม **หมวดหมู่** (เช่น "แบบทดสอบ", "การบ้าน") ภายในองค์ประกอบที่เลือก แต่ละหมวดหมู่ก็มีน้ำหนักของตัวเองด้วย น้ำหนักรวมของหมวดหมู่ในองค์ประกอบต้องเป็น 100%</li>
                            <li>คุณสามารถเพิ่ม **รายการย่อย** (เช่น "แบบทดสอบที่ 1", "การบ้าน 2") ให้แต่ละหมวดหมู่ โดยแต่ละรายการมีคะแนนเต็มของตัวเอง</li>
                            <li>ใช้ปุ่ม **"นำเข้าหมวดหมู่ (CSV)"** เพื่อเพิ่มหลายหมวดหมู่พร้อมกัน รูปแบบ: `ชื่อหมวดหมู่,น้ำหนัก` (เช่น `การมีส่วนร่วม,10`)</li>
                        </ul>
                    </li>
                    <li>
                        <p class="font-medium text-white"><strong>5. จัดการข้อมูลนักเรียน:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-sm">
                            <li>เพิ่มนักเรียนใหม่ด้วยตนเองโดยการกรอกรายละเอียด</li>
                            <li>ใช้ **"นำเข้าจากไฟล์ CSV"** เพื่อเพิ่มนักเรียนหลายคน รูปแบบ: `studentId,realName,nickname,rollNumber` (เช่น `S001,สมชาย ใจดี,ชาย,1`)</li>
                            <li>คุณสามารถ **แก้ไข** หรือ **ลบ** นักเรียนจากรายชื่อได้ การลบต้องได้รับการยืนยัน</li>
                        </ul>
                    </li>
                    <li>
                        <p class="font-medium text-white"><strong>การกรอกคะแนน & รายงานสรุป:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-sm">
                            <li>สลับไปที่แท็บ **"บันทึกคะแนน"** เพื่อกรอกคะแนนสำหรับนักเรียนแต่ละคนในตาราง กด `Enter` เพื่อเลื่อนไปยังช่องถัดไป</li>
                            <li>ไปที่แท็บ **"สรุปและรายงาน"** เพื่อดูคะแนนรวม, เกรด, และภาพรวมผลการเรียน (ยอดเยี่ยม, ปานกลาง, ต้องปรับปรุง)</li>
                            <li>**แดชบอร์ดผู้ดูแลระบบ** (ไอคอนโล่มุมบนขวา) มีภาพรวมของทุกวิชาและสถานะการทำงานของครู</li>
                        </ul>
                    </li>
                    <li>
                        <p class="font-medium text-white"><strong>รีเซ็ตคอร์ส:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-sm">
                            <li>ปุ่ม **"รีเซ็ตคอร์ส"** (ไอคอนถังขยะ) จะลบข้อมูลทั้งหมดสำหรับคอร์สที่เลือกอยู่ ซึ่งต้องใส่ Token เพื่อยืนยัน</li>
                        </ul>
                    </li>
                </ol>

                <p>ข้อมูลทั้งหมดจะถูกบันทึกไปยังฐานข้อมูลแบบเรียลไทม์! ขอให้สนุกกับการใช้งานโปรแกรมบันทึกเกรด!</p>
            </div>
            <div class="flex justify-end mt-4">
                <button onclick="hideHowToUseModal()" class="bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700">รับทราบ!</button>
            </div>
        </div>
    </div>

    <div id="toast" class=""></div>


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, collection, setDoc, onSnapshot, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // โค้ดส่วนนี้ควรได้รับการจัดการอย่างปลอดภัย ไม่ควรเปิดเผยต่อสาธารณะ
        // ในโปรเจกต์จริง ควรใช้ Environment Variables หรือ Firebase Functions
        const firebaseConfig = {
            apiKey: "AIzaSyA8L7xv3Sk_a0p20kNmWs8KG_79zU11kss",
            authDomain: "appht-8e3dd.firebaseapp.com",
            projectId: "appht-8e3dd",
            storageBucket: "appht-8e3dd.firebasestorage.app",
            messagingSenderId: "389229211407",
            appId: "1:389229211407:web:649da66f5c01d5396fd87a",
            measurementId: "G-42LTYDJ4WL"
        };
        
        // ** Token การเข้าถึงสำหรับ Admin และการรีเซ็ต **
        // ในการใช้งานจริง ควรเก็บไว้ในที่ปลอดภัยและเปลี่ยนเป็นรหัสที่ซับซ้อน
        const ADMIN_ACCESS_TOKEN = "ADMIN_1234"; 
        const RESET_COURSE_TOKEN = "RESET_5678";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL STATE & CONSTANTS ---
        let courses = [];
        let students = [];
        let activeCourse = null;
        let selectedAcademicYear = '';
        let selectedSemester = '';
        let selectedAssessmentComponent = null;
        let studentGroupChartInstance = null;
        let editingCategoryIndex = -1;
        let originalCategoryState = null;
        let editingAssessmentComponentIndex = -1;
        let originalAssessmentComponentState = null;
        let editingStudentId = null;
        let originalStudentState = null;
        let currentConfirmCallback = null;

        const tableHeaderColors = ['#1e3a8a', '#064e3b', '#78350f', '#991b1b', '#5b21b6'];
        const subjectsList = ['English', 'Maths', 'Science', 'Thai', 'ICT', 'Global Skills', 'ART', 'Sport Club', 'Geography', 'Music', 'Wellbeing', 'History', 'Data Literacy', 'Reading & Presentation', 'Problem Solving', 'Chinese', 'Writing', 'Presentation'];
        const gradeLevelsList = Array.from({ length: 13 }, (_, i) => `Y${i + 1}`);

        // Helper function to format numbers (remove .00 if integer)
        function formatNumber(value) {
            const num = parseFloat(value);
            if (isNaN(num) || !isFinite(num)) return 'N/A'; // Handle NaN or Infinity
            if (num === Math.floor(num)) return num.toString();
            return num.toFixed(2);
        }

        // --- DATA PERSISTENCE (Firebase Firestore) ---
        // Saves current state of courses and students to Firestore
        async function saveData() {
            try {
                if (!activeCourse || !activeCourse.id) {
                    console.warn("No active course selected, skipping save.");
                    return;
                }
                // Use setDoc to save the entire course object
                await setDoc(doc(db, "courses", activeCourse.id), activeCourse);
                
                // Use setDoc for each student with merge option to prevent overwriting
                const studentSavePromises = students.map(student =>
                    setDoc(doc(db, "students", student.studentId), student, { merge: true })
                );
                await Promise.all(studentSavePromises);

                console.log("Data saved to Firestore successfully!");
            } catch (e) {
                console.error("Error saving data to Firestore:", e);
                showToast('บันทึกข้อมูลล้มเหลว.', 'error');
            }
        }

        // Loads data from Firebase Firestore
        async function loadData() {
            try {
                // Listen for real-time changes to courses
                onSnapshot(collection(db, "courses"), (snapshot) => {
                    courses = snapshot.docs.map(doc => doc.data());
                    
                    const storedActiveCourseId = localStorage.getItem('gradingSheetActiveCourseId');
                    if (storedActiveCourseId) {
                        activeCourse = courses.find(c => c.id === storedActiveCourseId);
                        if (activeCourse) {
                            const storedSelectedAssessmentComponentId = localStorage.getItem('gradingSheetSelectedAssessmentComponentId');
                            if (storedSelectedAssessmentComponentId && activeCourse.assessmentComponents) {
                                selectedAssessmentComponent = activeCourse.assessmentComponents.find(p => p.id === storedSelectedAssessmentComponentId);
                            } else {
                                selectedAssessmentComponent = null;
                            }
                        } else {
                            selectedAssessmentComponent = null;
                        }
                    } else {
                        activeCourse = null;
                        selectedAssessmentComponent = null;
                    }
                    
                    populateDropdowns();
                    updateMainContentState();
                    console.log("Courses data updated from Firestore.");
                }, (error) => {
                    console.error("Error listening to courses:", error);
                    showToast('ไม่สามารถโหลดข้อมูลคอร์สได้.', 'error');
                });

                // Listen for real-time changes to students
                onSnapshot(collection(db, "students"), (snapshot) => {
                    students = snapshot.docs.map(doc => doc.data());
                    updateMainContentState();
                    console.log("Students data updated from Firestore.");
                }, (error) => {
                    console.error("Error listening to students:", error);
                    showToast('ไม่สามารถโหลดข้อมูลนักเรียนได้.', 'error');
                });

                console.log("Firestore listeners setup.");
            } catch (e) {
                console.error("Error setting up Firestore listeners:", e);
                showToast('ไม่สามารถตั้งค่าการเชื่อมต่อฐานข้อมูลได้.', 'error');
                courses = [];
                students = [];
                activeCourse = null;
                selectedAssessmentComponent = null;
                populateDropdowns();
                updateMainContentState();
            }
        }

        // --- MODAL & UI HELPERS ---
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = ``;
            toast.classList.add(type, 'show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function showAlert(title, message) {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-modal').classList.remove('hidden');
        }
        function hideAlert() {
            document.getElementById('alert-modal').classList.add('hidden');
        }

        function showConfirmationModal(title, message, onConfirmCallback) {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;
            currentConfirmCallback = onConfirmCallback;
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function hideConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
            currentConfirmCallback = null;
        }

        document.getElementById('confirm-action-button').addEventListener('click', () => {
            if (currentConfirmCallback) {
                currentConfirmCallback();
            }
            hideConfirmationModal();
        });


        function showResetConfirmationModal() {
            if (!activeCourse) {
                showAlert("จำเป็นต้องดำเนินการ", "กรุณาเลือกวิชาก่อนทำการรีเซ็ตข้อมูล");
                return;
            }
            document.getElementById('reset-password-input').value = '';
            document.getElementById('reset-confirmation-modal').classList.remove('hidden');
        }
        function hideResetConfirmationModal() {
            document.getElementById('reset-confirmation-modal').classList.add('hidden');
        }

        function confirmResetCourse() {
            const passwordInput = document.getElementById('reset-password-input').value;
            if (passwordInput === RESET_COURSE_TOKEN) {
                resetCourseData();
                hideResetConfirmationModal();
            } else {
                showAlert("ข้อผิดพลาด", "Token ไม่ถูกต้อง");
                document.getElementById('reset-password-input').value = '';
            }
        }

        function showAdminPasswordModal() {
            document.getElementById('admin-password-input').value = '';
            document.getElementById('admin-password-modal').classList.remove('hidden');
        }
        function hideAdminPasswordModal() { document.getElementById('admin-password-modal').classList.add('hidden'); }
        function showSettingsModal() {
            document.getElementById('settings-logo-url').value = activeCourse?.teacher?.logoUrl || '';
            document.getElementById('settings-admin-token').value = ADMIN_ACCESS_TOKEN;
            document.getElementById('settings-modal').classList.remove('hidden');
        }
        function hideSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }

        function showHowToUseModal() {
            document.getElementById('how-to-use-modal').classList.remove('hidden');
        }
        function hideHowToUseModal() {
            document.getElementById('how-to-use-modal').classList.add('hidden');
        }

        function showScoreBreakdownModal(studentId) {
            const student = students.find(s => s.studentId === studentId);
            if (!student || !activeCourse) return;

            document.getElementById('score-breakdown-modal-title').textContent = `รายละเอียดคะแนนสำหรับ ${student.realName}`;
            const contentDiv = document.getElementById('score-breakdown-content');
            contentDiv.innerHTML = activeCourse.assessmentComponents.map(component => {
                let componentHtml = `<div class="p-2 border rounded-md bg-slate-700 border-slate-500 mb-2">
                                <p class="font-bold text-indigo-300">${component.name} (${component.weight}%)</p>`;
                if (component.categories && component.categories.length > 0) {
                    componentHtml += `<ul class="list-disc list-inside ml-4 text-sm space-y-1">`;
                    component.categories.forEach(cat => {
                        const { current, max } = getCategoryScores(student, component.name, cat, activeCourse);
                        const percentage = max > 0 ? (current / max) * 100 : 0;
                        componentHtml += `<li>${cat.name} (${cat.weight}% ขององค์ประกอบ): ${formatNumber(current)}/${formatNumber(max)} (${formatNumber(percentage)}%)`;
                        if (cat.subItems && cat.subItems.length > 0) {
                            componentHtml += `<ul class="list-circle list-inside ml-4 text-xs">`;
                            cat.subItems.forEach(sub => {
                                const subScore = student.scores[activeCourse.id]?.[component.name]?.[cat.name]?.[sub.id] || 0;
                                componentHtml += `<li>${sub.name}: ${formatNumber(subScore)}/${formatNumber(sub.maxScore)}</li>`;
                            });
                            componentHtml += `</ul>`;
                        }
                        componentHtml += `</li>`;
                    });
                    componentHtml += `</ul>`;
                } else {
                    componentHtml += `<p class="text-slate-400 text-xs ml-4">ยังไม่ได้กำหนดหมวดหมู่สำหรับองค์ประกอบนี้</p>`;
                }
                return componentHtml + `</div>`;
            }).join('');
            document.getElementById('score-breakdown-modal').classList.remove('hidden');
        }
        function hideScoreBreakdownModal() { document.getElementById('score-breakdown-modal').classList.add('hidden'); }
        function hideAdminDashboardModal() { document.getElementById('admin-dashboard-modal').classList.add('hidden'); }

        function checkAdminPassword() {
            const password = document.getElementById('admin-password-input').value;
            if (password === ADMIN_ACCESS_TOKEN) {
                hideAdminPasswordModal();
                renderAdminDashboard();
                document.getElementById('admin-dashboard-modal').classList.remove('hidden');
            } else {
                showAlert("การเข้าถึงถูกปฏิเสธ", "Token ไม่ถูกต้อง");
                document.getElementById('admin-password-input').value = '';
            }
        }

        async function saveSettings() {
            if (!activeCourse) {
                showToast("กรุณาเลือกวิชาก่อน", "error");
                return;
            }
            const logoUrl = document.getElementById('settings-logo-url').value.trim();
            // Ensure activeCourse.teacher exists before assigning logoUrl
            if (!activeCourse.teacher) {
                activeCourse.teacher = {};
            }
            activeCourse.teacher.logoUrl = logoUrl;
            document.getElementById('school-logo').src = logoUrl || 'https://placehold.co/64x64/1e293b/e2e8f0?text=Logo';
            await saveData();
            hideSettingsModal();
            showToast("บันทึกการตั้งค่าเรียบร้อยแล้ว!");
        }

        // --- INITIALIZATION ---
        function populateDropdowns() {
            const subjectSelect = document.getElementById('select-subject');
            const gradeLevelSelect = document.getElementById('select-grade-level');
            const academicYearSelect = document.getElementById('select-academic-year');
            const semesterSelect = document.getElementById('select-semester');

            const currentSubject = subjectSelect.value;
            const currentGrade = gradeLevelSelect.value;
            const currentAcademicYearSelection = academicYearSelect.value;
            const currentSemesterSelection = semesterSelect.value;
            const currentRoom = document.getElementById('select-room').value;

            subjectSelect.innerHTML = '<option value="">เลือกวิชา</option>' + subjectsList.map(s => `<option value="${s}">${s}</option>`).join('');
            gradeLevelSelect.innerHTML = '<option value="">เลือกระดับชั้น</option>' + gradeLevelsList.map(g => `<option value="${g}">${g}</option>`).join('');

            const currentYear = new Date().getFullYear();
            const academicYears = [];
            for (let i = 0; i <= 10; i++) {
                academicYears.push(currentYear + i);
            }
            academicYearSelect.innerHTML = '<option value="">เลือกปีการศึกษา</option>' + academicYears.map(y => `<option value="${y}">${y}</option>`).join('');

            const semesters = ['Term 1', 'Term 2', 'Term 3'];
            semesterSelect.innerHTML = '<option value="">เลือกภาคเรียน</option>' + semesters.map(s => `<option value="${s}">${s}</option>`).join('');

            academicYearSelect.value = currentAcademicYearSelection || (activeCourse ? activeCourse.academicYear : '') || currentYear;
            semesterSelect.value = currentSemesterSelection || (activeCourse ? activeCourse.semester : '') || 'Term 1';
            subjectSelect.value = activeCourse?.subject || currentSubject;
            gradeLevelSelect.value = activeCourse?.gradeLevel || currentGrade;
            document.getElementById('select-room').value = activeCourse?.room || currentRoom;

            selectedAcademicYear = academicYearSelect.value;
            selectedSemester = semesterSelect.value;
        }

        // --- UI STATE MANAGEMENT ---
        function updateMainContentState() {
            const isAcademicPeriodSelected = document.getElementById('select-academic-year').value && document.getElementById('select-semester').value;
            const academicPeriodStatusDiv = document.getElementById('academic-period-status');
            const courseSelectionSection = document.getElementById('course-selection-section');
            const courseSelectionOverlay = document.getElementById('course-selection-overlay');
            const teacherInfoContainer = document.getElementById('teacher-info-container');
            const teacherInfoContainerOverlay = document.getElementById('teacher-info-container-overlay');

            if (isAcademicPeriodSelected) {
                academicPeriodStatusDiv.classList.add('hidden');
                academicPeriodStatusDiv.className = 'p-3 rounded-md text-center font-medium mt-4 hidden';
                courseSelectionSection.classList.remove('disabled-section');
                courseSelectionOverlay.classList.add('hidden');
            } else {
                academicPeriodStatusDiv.classList.remove('hidden');
                academicPeriodStatusDiv.textContent = 'กรุณาเลือกทั้งปีการศึกษาและภาคเรียน';
                academicPeriodStatusDiv.className = 'p-3 rounded-md text-center font-medium mt-4 bg-yellow-900/50 text-yellow-300';
                courseSelectionSection.classList.add('disabled-section');
                courseSelectionOverlay.classList.remove('hidden');
            }

            const isCourseSelected = document.getElementById('select-subject').value && document.getElementById('select-grade-level').value && document.getElementById('select-room').value;
            const isTeacherInfoSaved = activeCourse && activeCourse.teacher && activeCourse.teacher.realName;

            const isReadyForMainContent = isAcademicPeriodSelected && isCourseSelected && isTeacherInfoSaved;

            const mainContent = document.getElementById('main-content-area');
            const mainContentOverlay = document.getElementById('main-content-overlay');

            if (isAcademicPeriodSelected && isCourseSelected) {
                teacherInfoContainer.classList.remove('disabled-section');
                teacherInfoContainerOverlay.classList.add('hidden');
            } else {
                teacherInfoContainer.classList.add('disabled-section');
                teacherInfoContainerOverlay.classList.remove('hidden');
                teacherInfoContainerOverlay.querySelector('span').textContent = 'กรุณาเลือกวิชาด้านบน';
            }

            if (isReadyForMainContent) {
                mainContent.classList.remove('disabled-section');
                mainContentOverlay.classList.add('hidden');
            } else {
                mainContent.classList.add('disabled-section');
                mainContentOverlay.classList.remove('hidden');
                let overlayMessage = 'กรุณากรอกข้อมูลให้ครบ: ';
                let missingSteps = [];
                if (!isAcademicPeriodSelected) missingSteps.push('ปีการศึกษา & ภาคเรียน');
                if (!isCourseSelected) missingSteps.push('เลือกวิชา');
                if (!isTeacherInfoSaved) missingSteps.push('ข้อมูลครูผู้สอน (และกดบันทึกข้อมูล)');
                mainContentOverlay.querySelector('span').textContent = overlayMessage + missingSteps.join(', ') + '.';
            }
            renderAll();
        }

        // --- COURSE & TEACHER LOGIC ---
        function updateAcademicYearSelection() {
            selectedAcademicYear = document.getElementById('select-academic-year').value;
            updateCourseSelection();
            localStorage.setItem('gradingSheetSelectedAcademicYear', selectedAcademicYear);
        }

        function updateSemesterSelection() {
            selectedSemester = document.getElementById('select-semester').value;
            updateCourseSelection();
            localStorage.setItem('gradingSheetSelectedSemester', selectedSemester);
        }

        async function updateCourseSelection() {
            const academicYear = document.getElementById('select-academic-year').value;
            const semester = document.getElementById('select-semester').value;
            const subject = document.getElementById('select-subject').value;
            const grade = document.getElementById('select-grade-level').value;
            const room = document.getElementById('select-room').value;
            const statusDiv = document.getElementById('course-selection-status');

            if (!academicYear || !semester) {
                activeCourse = null;
                document.getElementById('school-logo').src = 'https://placehold.co/64x64/1e293b/e2e8f0?text=Logo';
                statusDiv.textContent = 'กรุณาเลือกปีการศึกษาและภาคเรียนก่อน';
                statusDiv.className = 'p-3 rounded-md text-center font-medium bg-yellow-900/50 text-yellow-300';
                statusDiv.classList.remove('hidden');
                updateMainContentState();
                return;
            }

            if (subject && grade && room) {
                const courseId = `${subject}-${grade}-${room}-${academicYear}-${semester}`;
                let course = courses.find(c => c.id === courseId);
                if (!course) {
                    course = { id: courseId, subject, gradeLevel: grade, room, academicYear, semester, assessmentComponents: [], teacher: {} };
                    courses.push(course);
                    await saveData();
                    statusDiv.textContent = `สร้างวิชาใหม่: ${subject} (${grade}/${room}) - ${academicYear} ${semester}`;
                    statusDiv.className = 'p-3 rounded-md text-center font-medium bg-blue-900/50 text-blue-300';
                } else {
                    statusDiv.textContent = `โหลดวิชา: ${subject} (${grade}/${room}) - ${academicYear} ${semester}`;
                    statusDiv.className = 'p-3 rounded-md text-center font-medium bg-green-900/50 text-green-300';
                }
                activeCourse = course;
                localStorage.setItem('gradingSheetActiveCourseId', activeCourse.id);

                document.getElementById('teacher-real-name').value = activeCourse.teacher.realName || '';
                document.getElementById('teacher-id').value = activeCourse.teacher.id || '';
                const logoUrl = activeCourse.teacher?.logoUrl || '';
                document.getElementById('school-logo').src = logoUrl || 'https://placehold.co/64x64/1e293b/e2e8f0?text=Logo';

                renderTeacherInfoSection();
                checkTeacherFormValidity();
            } else {
                activeCourse = null;
                localStorage.removeItem('gradingSheetActiveCourseId');
                document.getElementById('school-logo').src = 'https://placehold.co/64x64/1e293b/e2e8f0?text=Logo';
                statusDiv.textContent = 'กรุณาเลือกข้อมูลวิชาให้ครบ';
                statusDiv.className = 'p-3 rounded-md text-center font-medium bg-yellow-900/50 text-yellow-300';
                renderTeacherInfoSection();
            }
            statusDiv.classList.remove('hidden');
            updateMainContentState();
            renderAssessmentComponents();
            updateCategoryManagementSectionState();
        }

        function checkTeacherFormValidity() {
            const realName = document.getElementById('teacher-real-name').value.trim();
            const saveButton = document.getElementById('save-teacher-info-button');
            const hint = document.getElementById('save-teacher-hint');

            saveButton.disabled = !activeCourse || !realName;

            if (!saveButton.disabled && (!activeCourse.teacher || !activeCourse.teacher.realName)) {
                hint.classList.remove('hidden');
            } else {
                hint.classList.add('hidden');
            }
        }

        async function saveTeacherInfo() {
            if (!activeCourse) return;
            activeCourse.teacher.realName = document.getElementById('teacher-real-name').value.trim();
            activeCourse.teacher.id = document.getElementById('teacher-id').value.trim();
            await saveData();
            showToast('บันทึกข้อมูลครูเรียบร้อยแล้ว!', 'success');
            renderTeacherInfoSection();
            updateMainContentState();
        }

        function renderTeacherInfoSection() {
            const displayDiv = document.getElementById('teacher-info-display');
            const editFormDiv = document.getElementById('teacher-info-edit-form');
            const teacherNameInput = document.getElementById('teacher-real-name');
            const teacherIdInput = document.getElementById('teacher-id');
            const saveTeacherHint = document.getElementById('save-teacher-hint');

            if (activeCourse && activeCourse.teacher && activeCourse.teacher.realName) {
                displayDiv.classList.remove('hidden');
                editFormDiv.classList.add('hidden');
                document.getElementById('display-teacher-name').textContent = activeCourse.teacher.realName;
                document.getElementById('display-teacher-id').textContent = `รหัส: ${activeCourse.teacher.id || 'N/A'}`;
                saveTeacherHint.classList.add('hidden');
            } else {
                displayDiv.classList.add('hidden');
                editFormDiv.classList.remove('hidden');
                if (!activeCourse || !activeCourse.teacher || !activeCourse.teacher.realName) {
                    teacherNameInput.value = '';
                    teacherIdInput.value = '';
                }
                checkTeacherFormValidity();
            }
        }

        function editTeacherInfo() {
            const displayDiv = document.getElementById('teacher-info-display');
            const editFormDiv = document.getElementById('teacher-info-edit-form');
            const teacherNameInput = document.getElementById('teacher-real-name');
            const teacherIdInput = document.getElementById('teacher-id');

            displayDiv.classList.add('hidden');
            editFormDiv.classList.remove('hidden');

            teacherNameInput.value = activeCourse.teacher.realName || '';
            teacherIdInput.value = activeCourse.teacher.id || '';
            checkTeacherFormValidity();
        }

        function showDeleteTeacherConfirmation() {
            showConfirmationModal(
                'ยืนยันการลบข้อมูลครู',
                'คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลครูสำหรับวิชานี้? การดำเนินการนี้ไม่สามารถย้อนกลับได้',
                deleteTeacherInfo
            );
        }

        async function deleteTeacherInfo() {
            if (!activeCourse) return;
            activeCourse.teacher = {};
            await saveData();
            showToast('ข้อมูลครูถูกลบเรียบร้อยแล้ว!', 'success');
            renderTeacherInfoSection();
            updateMainContentState();
        }

        async function resetCourseData() {
            if (!activeCourse) return;
            const courseIdentifier = `${activeCourse.subject} (${activeCourse.gradeLevel}/${activeCourse.room}) - ${activeCourse.academicYear} ${activeCourse.semester}`;
            
            activeCourse.assessmentComponents = [];
            activeCourse.teacher = {};
            
            const studentUpdatePromises = students.map(async s => {
                if (s.scores && s.scores[activeCourse.id]) {
                    delete s.scores[activeCourse.id];
                    await setDoc(doc(db, "students", s.studentId), s, { merge: true });
                }
            });
            await Promise.all(studentUpdatePromises);

            await setDoc(doc(db, "courses", activeCourse.id), activeCourse, { merge: true });
            
            showToast(`ข้อมูลทั้งหมดสำหรับวิชา "${courseIdentifier}" ได้ถูกรีเซ็ตแล้ว!`, 'success');

            activeCourse = null;
            selectedAssessmentComponent = null;
            document.getElementById('select-subject').value = '';
            document.getElementById('select-grade-level').value = '';
            document.getElementById('select-room').value = '';
            document.getElementById('select-academic-year').value = '';
            document.getElementById('select-semester').value = '';
            selectedAcademicYear = '';
            selectedSemester = '';
            document.getElementById('course-selection-status').classList.add('hidden');
            renderTeacherInfoSection();
            renderAssessmentComponents();
            updateCategoryManagementSectionState();
            renderAll();
        }

        // --- NEW: ASSESSMENT COMPONENT LOGIC ---
        function updateTotalAssessmentComponentWeightDisplay() {
            const totalWeightSpan = document.getElementById('current-total-grading-period-weight');
            const warningDiv = document.getElementById('grading-period-warning');

            if (!totalWeightSpan || !warningDiv) {
                return;
            }

            if (!activeCourse) {
                totalWeightSpan.textContent = '0';
                warningDiv.classList.add('hidden');
                return;
            }
            const totalWeight = activeCourse.assessmentComponents.reduce((sum, component) => sum + Number(component.weight), 0);
            totalWeightSpan.textContent = totalWeight;
            warningDiv.classList.toggle('hidden', totalWeight === 100 || activeCourse.assessmentComponents.length === 0);
        }

        function renderAssessmentComponents() {
            const container = document.getElementById('grading-period-list');
            const selectDropdown = document.getElementById('select-grading-period');
            if (!activeCourse) {
                container.innerHTML = '';
                selectDropdown.innerHTML = '<option value="">เลือกองค์ประกอบการประเมิน</option>';
                return;
            }

            container.innerHTML = activeCourse.assessmentComponents.map((component, index) => {
                const isEditing = editingAssessmentComponentIndex === index;
                if (isEditing) {
                    return `
                        <div class="p-3 rounded-md shadow-sm border border-indigo-500 card flex items-center gap-2">
                            <input type="text" value="${component.name}" class="grading-period-name-input flex-grow p-2">
                            <input type="number" value="${component.weight}" class="grading-period-weight-input w-20 p-2 text-center">
                            <span class="text-slate-400">%</span>
                            <button onclick="saveAssessmentComponentChanges(${index})" class="bg-green-600 text-white px-3 py-2 rounded-md text-sm">บันทึก</button>
                            <button onclick="cancelEditAssessmentComponent()" class="bg-slate-400 text-white px-3 py-2 rounded-md text-sm">ยกเลิก</button>
                        </div>`;
                } else {
                    return `
                        <div class="flex items-center gap-2 p-2 rounded-md border card">
                            <span class="flex-grow font-medium">${component.name} (${component.weight}%)</span>
                            <button onclick="startEditAssessmentComponent(${index})" class="bg-yellow-600 text-white px-3 py-1 rounded-md text-sm">แก้ไข</button>
                            <button onclick="showDeleteAssessmentComponentConfirmation(${index})" class="bg-red-600 text-white px-3 py-1 rounded-md text-sm">ลบ</button>
                        </div>`;
                }
            }).join('');

            const currentSelectedComponentId = selectedAssessmentComponent ? selectedAssessmentComponent.id : '';
            selectDropdown.innerHTML = '<option value="">เลือกองค์ประกอบการประเมิน</option>' + activeCourse.assessmentComponents.map(component =>
                `<option value="${component.id}" ${component.id === currentSelectedComponentId ? 'selected' : ''}>${component.name}</option>`
            ).join('');

            updateTotalAssessmentComponentWeightDisplay();
            updateCategoryManagementSectionState();
        }

        async function addGradingPeriod() {
            if (!activeCourse) return;
            const nameInput = document.getElementById('new-grading-period-name');
            const weightInput = document.getElementById('new-grading-period-weight');
            const name = nameInput.value.trim();
            const weight = parseFloat(weightInput.value);

            if (!name || isNaN(weight) || weight <= 0) { showToast('กรุณาใส่ชื่อองค์ประกอบและน้ำหนักที่ถูกต้อง.', 'error'); return; }
            if (activeCourse.assessmentComponents.some(p => p.name.toLowerCase() === name.toLowerCase())) { showToast('ชื่อองค์ประกอบการประเมินนี้มีอยู่แล้ว.', 'error'); return; }
            const totalWeight = activeCourse.assessmentComponents.reduce((sum, p) => sum + p.weight, 0);
            if (totalWeight + weight > 100) { showToast('น้ำหนักรวมขององค์ประกอบไม่สามารถเกิน 100% ได้.', 'error'); return; }

            activeCourse.assessmentComponents.push({ id: crypto.randomUUID(), name, weight, categories: [] });
            nameInput.value = '';
            weightInput.value = '';
            await saveData();
            renderAssessmentComponents();
            selectGradingPeriod();
            renderAll();
        }

        function startEditAssessmentComponent(index) {
            if (editingAssessmentComponentIndex !== -1) { showToast('กรุณาบันทึกหรือยกเลิกการแก้ไของค์ประกอบปัจจุบันก่อน.', 'error'); return; }
            editingAssessmentComponentIndex = index;
            originalAssessmentComponentState = JSON.parse(JSON.stringify(activeCourse.assessmentComponents[index]));
            renderAssessmentComponents();
        }

        function cancelEditAssessmentComponent() {
            if (originalAssessmentComponentState) {
                activeCourse.assessmentComponents[editingAssessmentComponentIndex] = originalAssessmentComponentState;
            }
            editingAssessmentComponentIndex = -1;
            originalAssessmentComponentState = null;
            renderAssessmentComponents();
        }

        async function saveAssessmentComponentChanges(index) {
            const componentElement = document.querySelector(`#grading-period-list > div:nth-child(${index + 1})`);
            const newName = componentElement.querySelector('.grading-period-name-input').value.trim();
            const newWeight = parseFloat(componentElement.querySelector('.grading-period-weight-input').value);

            if (!newName || isNaN(newWeight) || newWeight < 0) { showToast('ชื่อองค์ประกอบหรือน้ำหนักไม่ถูกต้อง.', 'error'); return; }
            if (activeCourse.assessmentComponents.some((p, i) => i !== index && p.name.toLowerCase() === newName.toLowerCase())) { showToast('ชื่อองค์ประกอบการประเมินนี้มีอยู่แล้ว.', 'error'); return; }
            const totalWeight = activeCourse.assessmentComponents.reduce((sum, p, i) => sum + (i === index ? newWeight : p.weight), 0);
            if (totalWeight > 100) { showToast('น้ำหนักรวมขององค์ประกอบเกิน 100%.', 'error'); return; }

            if (newName !== originalAssessmentComponentState.name) {
                const studentUpdatePromises = students.map(async s => {
                    if (s.scores[activeCourse.id] && s.scores[activeCourse.id][originalAssessmentComponentState.name]) {
                        s.scores[activeCourse.id][newName] = s.scores[activeCourse.id][originalAssessmentComponentState.name];
                        delete s.scores[activeCourse.id][originalAssessmentComponentState.name];
                        await setDoc(doc(db, "students", s.studentId), s, { merge: true });
                    }
                });
                await Promise.all(studentUpdatePromises);
            }

            activeCourse.assessmentComponents[index].name = newName;
            activeCourse.assessmentComponents[index].weight = newWeight;
            editingAssessmentComponentIndex = -1;
            originalAssessmentComponentState = null;
            await saveData();
            showToast('บันทึกการเปลี่ยนแปลงองค์ประกอบการประเมินแล้ว!', 'success');
            renderAssessmentComponents();
            renderAll();
        }

        function showDeleteAssessmentComponentConfirmation(index) {
            const componentName = activeCourse.assessmentComponents[index].name;
            showConfirmationModal(
                'ยืนยันการลบองค์ประกอบการประเมิน',
                `คุณแน่ใจหรือไม่ว่าต้องการลบองค์ประกอบ "${componentName}"? หมวดหมู่และคะแนนที่เกี่ยวข้องทั้งหมดในองค์ประกอบนี้จะถูกลบออก การดำเนินการนี้ไม่สามารถย้อนกลับได้`,
                () => deleteAssessmentComponent(index)
            );
        }

        async function deleteAssessmentComponent(index) {
            if (!activeCourse) return;
            const componentIdToDelete = activeCourse.assessmentComponents[index].id;
            const componentName = activeCourse.assessmentComponents[index].name;

            const studentUpdatePromises = students.map(async s => {
                if (s.scores[activeCourse.id] && s.scores[activeCourse.id][componentName]) {
                    delete s.scores[activeCourse.id][componentName];
                    await setDoc(doc(db, "students", s.studentId), s, { merge: true });
                }
            });
            await Promise.all(studentUpdatePromises);

            activeCourse.assessmentComponents.splice(index, 1);
            await saveData();
            showToast(`องค์ประกอบ "${componentName}" ถูกลบแล้ว.`, 'success');

            if (selectedAssessmentComponent && selectedAssessmentComponent.id === componentIdToDelete) {
                selectedAssessmentComponent = null;
                document.getElementById('select-grading-period').value = '';
            }
            renderAssessmentComponents();
            updateCategoryManagementSectionState();
            renderAll();
        }

        function selectGradingPeriod() {
            const selectElement = document.getElementById('select-grading-period');
            const componentId = selectElement.value;
            const statusDiv = document.getElementById('selected-grading-period-status');
            const currentComponentNameSpan = document.getElementById('current-period-name');

            if (componentId) {
                selectedAssessmentComponent = activeCourse.assessmentComponents.find(p => p.id === componentId);
                statusDiv.textContent = `กำลังจัดการหมวดหมู่สำหรับ: ${selectedAssessmentComponent.name}`;
                statusDiv.className = 'p-3 rounded-md text-center font-medium bg-blue-900/50 text-blue-300';
                currentComponentNameSpan.textContent = selectedAssessmentComponent.name;
                localStorage.setItem('gradingSheetSelectedAssessmentComponentId', selectedAssessmentComponent.id);
            } else {
                selectedAssessmentComponent = null;
                statusDiv.textContent = 'ไม่ได้เลือกองค์ประกอบการประเมิน';
                statusDiv.className = 'p-3 rounded-md text-center font-medium bg-yellow-900/50 text-yellow-300';
                currentComponentNameSpan.textContent = 'องค์ประกอบที่เลือก';
                localStorage.removeItem('gradingSheetSelectedAssessmentComponentId');
            }
            statusDiv.classList.remove('hidden');
            updateCategoryManagementSectionState();
            renderCategories();
            renderAll();
        }

        function updateCategoryManagementSectionState() {
            const categoryManagementSection = document.getElementById('category-management-section');
            const categoryManagementOverlay = document.getElementById('category-management-overlay');
            if (selectedAssessmentComponent) {
                categoryManagementSection.classList.remove('disabled-section');
                categoryManagementOverlay.classList.add('hidden');
            } else {
                categoryManagementSection.classList.add('disabled-section');
                categoryManagementOverlay.classList.remove('hidden');
            }
            updateTotalCategoryWeightDisplay();
        }

        // --- CATEGORY LOGIC (now nested under selectedAssessmentComponent) ---
        function updateTotalCategoryWeightDisplay() {
            const totalWeightSpan = document.getElementById('current-total-category-weight');
            const warningDiv = document.getElementById('category-weight-warning');

            if (!totalWeightSpan || !warningDiv) {
                return;
            }

            if (!selectedAssessmentComponent) {
                totalWeightSpan.textContent = '0';
                warningDiv.classList.add('hidden');
                return;
            }
            const totalWeight = selectedAssessmentComponent.categories.reduce((sum, cat) => sum + Number(cat.weight), 0);
            totalWeightSpan.textContent = totalWeight;
            warningDiv.classList.toggle('hidden', totalWeight === 100 || selectedAssessmentComponent.categories.length === 0);
        }

        function renderCategories() {
            const container = document.getElementById('category-settings');
            if (!selectedAssessmentComponent) { container.innerHTML = ''; return; }

            container.innerHTML = selectedAssessmentComponent.categories.map((cat, index) => {
                const isEditing = editingCategoryIndex === index;
                if (isEditing) {
                    return `
                        <details class="p-3 rounded-md shadow-sm border border-indigo-500 card" open>
                            <summary class="flex items-center gap-4 cursor-pointer font-medium text-lg">
                                <input type="text" value="${cat.name}" class="category-name-input flex-grow p-2">
                                <input type="number" value="${cat.weight}" class="category-weight-input w-20 p-2 text-center">
                                <span class="text-slate-400">%</span>
                                <button onclick="saveCategoryChanges(${index})" class="bg-green-600 text-white px-3 py-2 rounded-md text-sm">บันทึก</button>
                                <button onclick="cancelEditCategory()" class="bg-slate-400 text-white px-3 py-2 rounded-md text-sm">ยกเลิก</button>
                            </summary>
                            <div class="ml-8 mt-4 border-l-2 pl-4 border-slate-800">
                                <h4 class="text-md font-semibold mb-2">รายการย่อย:</h4>
                                <div id="sub-items-${index}" class="space-y-2 mb-4">${renderSubItems(index)}</div>
                                <div class="flex items-center gap-2">
                                    <input type="text" id="new-sub-item-name-${index}" placeholder="ชื่อรายการย่อย" class="flex-grow p-2">
                                    <input type="number" id="new-sub-item-max-score-${index}" placeholder="คะแนนเต็ม" class="w-24 p-2">
                                    <button onclick="addSubItem(${index})" class="bg-blue-500 text-white px-3 py-2 rounded-md">เพิ่ม</button>
                                </div>
                            </div>
                        </details>`;
                } else {
                    return `
                        <details class="p-3 rounded-md shadow-sm border card">
                            <summary class="flex items-center gap-4 cursor-pointer font-medium text-lg">
                                <span class="flex-grow">${cat.name} (${cat.weight}%)</span>
                                <button onclick="startEditCategory(${index})" class="bg-yellow-500 text-white px-3 py-2 rounded-md text-sm">แก้ไข</button>
                                <button onclick="showDeleteCategoryConfirmation(${index})" class="bg-red-500 text-white px-3 py-2 rounded-md text-sm">ลบ</button>
                            </summary>
                            <div class="ml-8 mt-4 border-l-2 pl-4 border-slate-800">
                                <h4 class="text-md font-semibold mb-2">รายการย่อย:</h4>
                                <div id="sub-items-readonly-${index}" class="space-y-2 mb-4">${renderSubItems(index)}</div>
                            </div>
                        </details>`;
                }
            }).join('');
            updateTotalCategoryWeightDisplay();
        }

        function renderSubItems(catIndex) {
            const cat = selectedAssessmentComponent.categories[catIndex];
            const isEditing = editingCategoryIndex === catIndex;
            if (!cat.subItems || cat.subItems.length === 0) return '<p class="text-slate-400 text-sm">ไม่มีรายการย่อยสำหรับหมวดหมู่นี้</p>';

            return cat.subItems.map((sub, subIndex) => {
                if (isEditing) {
                    return `<div class="flex items-center gap-2 bg-slate-800 p-2 rounded-md">
                                    <input type="text" value="${sub.name}" class="sub-item-name-input flex-grow p-1 text-sm">
                                    <input type="number" value="${sub.maxScore}" class="sub-item-max-score-input w-20 p-1 text-center text-sm">
                                    <button onclick="removeSubItem(${catIndex}, ${subIndex})" class="bg-red-400 text-white px-2 py-1 rounded-md text-sm">ลบ</button>
                                </div>`;
                } else {
                    return `<div class="flex items-center gap-2 bg-slate-800 p-2 rounded-md">
                                    <span class="flex-grow text-sm">${sub.name}</span>
                                    <span class="text-slate-400 text-sm">${formatNumber(sub.maxScore)} คะแนน</span>
                                </div>`;
                }
            }).join('');
        }

        async function addCategory() {
            if (!selectedAssessmentComponent) return;
            const nameInput = document.getElementById('new-category-name');
            const weightInput = document.getElementById('new-category-weight');
            const name = nameInput.value.trim();
            const weight = parseFloat(weightInput.value);

            if (!name || isNaN(weight) || weight <= 0) { showToast('กรุณาใส่ชื่อและน้ำหนักที่ถูกต้อง', 'error'); return; }
            if (selectedAssessmentComponent.categories.some(c => c.name.toLowerCase() === name.toLowerCase())) { showToast('ชื่อหมวดหมู่มีอยู่แล้วในองค์ประกอบนี้', 'error'); return; }
            const totalWeight = selectedAssessmentComponent.categories.reduce((sum, c) => sum + c.weight, 0);
            if (totalWeight + weight > 100) { showToast('น้ำหนักรวมของหมวดหมู่สำหรับองค์ประกอบนี้ไม่สามารถเกิน 100% ได้', 'error'); return; }

            selectedAssessmentComponent.categories.push({ id: crypto.randomUUID(), name, weight, subItems: [] });
            nameInput.value = '';
            weightInput.value = '';
            await saveData();
            renderCategories();
            renderAll();
        }

        async function handleCategoryCsvImport(event) {
            if (!selectedAssessmentComponent) {
                showToast("กรุณาเลือกองค์ประกอบการประเมินก่อนนำเข้าหมวดหมู่", "error");
                return;
            }
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async e => {
                const lines = e.target.result.split(/\r\n|\n/).filter(line => line.trim() !== '').slice(1);
                let added = 0, updated = 0, skipped = 0;
                for (const line of lines) {
                    const [categoryName, weight] = line.split(',').map(f => f.trim());
                    const parsedWeight = parseFloat(weight);

                    if (!categoryName || isNaN(parsedWeight) || parsedWeight <= 0) {
                        skipped++;
                        continue;
                    }

                    const existingIndex = selectedAssessmentComponent.categories.findIndex(c => c.name.toLowerCase() === categoryName.toLowerCase());
                    const totalWeight = selectedAssessmentComponent.categories.reduce((sum, c) => sum + c.weight, 0);

                    if (existingIndex !== -1) {
                        const currentCategoryWeight = selectedAssessmentComponent.categories[existingIndex].weight;
                        if ((totalWeight - currentCategoryWeight + parsedWeight) > 100) {
                            showToast(`ไม่สามารถอัปเดต "${categoryName}": น้ำหนักรวมสำหรับองค์ประกอบนี้จะเกิน 100%.`, 'error', 5000);
                            skipped++;
                            continue;
                        }
                        selectedAssessmentComponent.categories[existingIndex].weight = parsedWeight;
                        updated++;
                    } else if (totalWeight + parsedWeight > 100) {
                        showToast(`ไม่สามารถเพิ่ม "${categoryName}": น้ำหนักรวมสำหรับองค์ประกอบนี้จะเกิน 100%.`, 'error', 5000);
                        skipped++;
                        continue;
                    } else {
                        selectedAssessmentComponent.categories.push({ id: crypto.randomUUID(), name: categoryName, weight: parsedWeight, subItems: [] });
                        added++;
                    }
                }
                await saveData();
                renderCategories();
                showToast(`นำเข้าหมวดหมู่เสร็จสมบูรณ์! เพิ่ม: ${added}, อัปเดต: ${updated}, ข้าม: ${skipped}.`, 'success');
                renderAll();
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function showDeleteCategoryConfirmation(index) {
            const categoryName = selectedAssessmentComponent.categories[index].name;
            showConfirmationModal(
                'ยืนยันการลบหมวดหมู่',
                `คุณแน่ใจหรือไม่ว่าต้องการลบหมวดหมู่ "${categoryName}"? คะแนนที่เกี่ยวข้องทั้งหมดสำหรับหมวดหมู่นี้จะถูกลบออกจากนักเรียนทุกคน การดำเนินการนี้ไม่สามารถย้อนกลับได้`,
                () => deleteCategory(index)
            );
        }

        async function deleteCategory(index) {
            if (!selectedAssessmentComponent) return;
            const catName = selectedAssessmentComponent.categories[index].name;
            selectedAssessmentComponent.categories.splice(index, 1);
            
            const studentUpdatePromises = students.map(async s => {
                if (s.scores[activeCourse.id] && s.scores[activeCourse.id][selectedAssessmentComponent.name] && s.scores[activeCourse.id][selectedAssessmentComponent.name][catName]) {
                    delete s.scores[activeCourse.id][selectedAssessmentComponent.name][catName];
                    await setDoc(doc(db, "students", s.studentId), s, { merge: true });
                }
            });
            await Promise.all(studentUpdatePromises);

            await saveData();
            renderCategories();
            showToast(`หมวดหมู่ "${catName}" ถูกลบแล้ว`, 'success');
            renderAll();
        }

        function startEditCategory(index) {
            if (editingCategoryIndex !== -1) { showToast('กรุณาบันทึกหรือยกเลิกการแก้ไขปัจจุบันก่อน', 'error'); return; }
            editingCategoryIndex = index;
            originalCategoryState = JSON.parse(JSON.stringify(selectedAssessmentComponent.categories[index]));
            renderCategories();
        }

        function cancelEditCategory() {
            if (originalCategoryState) {
                selectedAssessmentComponent.categories[editingCategoryIndex] = originalCategoryState;
            }
            editingCategoryIndex = -1;
            originalCategoryState = null;
            renderCategories();
        }

        async function saveCategoryChanges(index) {
            const catElement = document.querySelector(`#category-settings details:nth-child(${index + 1})`);
            const newName = catElement.querySelector('.category-name-input').value.trim();
            const newWeight = parseFloat(catElement.querySelector('.category-weight-input').value);

            if (!newName || isNaN(newWeight) || newWeight < 0) { showToast('ชื่อหรือน้ำหนักไม่ถูกต้อง', 'error'); return; }
            if (selectedAssessmentComponent.categories.some((c, i) => i !== index && c.name.toLowerCase() === newName.toLowerCase())) { showToast('ชื่อหมวดหมู่มีอยู่แล้วในองค์ประกอบนี้', 'error'); return; }
            const totalWeight = selectedAssessmentComponent.categories.reduce((sum, c, i) => sum + (i === index ? newWeight : c.weight), 0);
            if (totalWeight > 100) { showToast('น้ำหนักรวมของหมวดหมู่สำหรับองค์ประกอบนี้ไม่สามารถเกิน 100% ได้', 'error'); return; }

            const newSubItems = [];
            const subItemElements = catElement.querySelectorAll(`#sub-items-${index} > div`);
            let hasInvalidSubItem = false;
            subItemElements.forEach(el => {
                const subName = el.querySelector('.sub-item-name-input')?.value.trim();
                const maxScore = parseFloat(el.querySelector('.sub-item-max-score-input')?.value);
                if (subName && !isNaN(maxScore) && maxScore >= 0) {
                    const existingSubItem = originalCategoryState.subItems?.find(sub => sub.name.toLowerCase() === subName.toLowerCase());
                    newSubItems.push({ id: existingSubItem ? existingSubItem.id : crypto.randomUUID(), name: subName, maxScore });
                } else if (subName && (isNaN(maxScore) || maxScore < 0)) {
                    showToast(`คะแนนเต็มสำหรับรายการย่อย "${subName}" ไม่ถูกต้อง. ต้องเป็นตัวเลข >= 0.`, 'error', 5000);
                    hasInvalidSubItem = true;
                }
            });
            if(hasInvalidSubItem) return;

            if (newName !== originalCategoryState.name) {
                const studentUpdatePromises = students.map(async s => {
                    if (s.scores[activeCourse.id] && s.scores[activeCourse.id][selectedAssessmentComponent.name] && s.scores[activeCourse.id][selectedAssessmentComponent.name][originalCategoryState.name]) {
                        s.scores[activeCourse.id][selectedAssessmentComponent.name][newName] = s.scores[activeCourse.id][selectedAssessmentComponent.name][originalCategoryState.name];
                        delete s.scores[activeCourse.id][selectedAssessmentComponent.name][originalCategoryState.name];
                        await setDoc(doc(db, "students", s.studentId), s, { merge: true });
                    }
                });
                await Promise.all(studentUpdatePromises);
            }

            selectedAssessmentComponent.categories[index] = { ...originalCategoryState, name: newName, weight: newWeight, subItems: newSubItems };
            editingCategoryIndex = -1;
            originalCategoryState = null;
            await saveData();
            renderCategories();
            showToast('บันทึกการเปลี่ยนแปลงหมวดหมู่แล้ว!', 'success');
            renderAll();
        }

        async function addSubItem(catIndex) {
            const name = document.getElementById(`new-sub-item-name-${catIndex}`).value.trim();
            const maxScore = parseFloat(document.getElementById(`new-sub-item-max-score-${catIndex}`).value);
            if (!name || isNaN(maxScore) || maxScore < 0) { showToast('ชื่อรายการย่อยหรือคะแนนเต็มไม่ถูกต้อง (ต้องเป็น >= 0).', 'error'); return; }

            const cat = selectedAssessmentComponent.categories[catIndex];
            if (!cat.subItems) cat.subItems = [];
            if (cat.subItems.some(sub => sub.name.toLowerCase() === name.toLowerCase())) {
                showToast('ชื่อรายการย่อยนี้มีอยู่แล้วในหมวดหมู่', 'error');
                return;
            }

            cat.subItems.push({ id: crypto.randomUUID(), name, maxScore });

            document.getElementById(`sub-items-${catIndex}`).innerHTML = renderSubItems(catIndex);
            document.getElementById(`new-sub-item-name-${catIndex}`).value = '';
            document.getElementById(`new-sub-item-max-score-${catIndex}`).value = '';
            await saveData();
            renderAll();
        }

        async function removeSubItem(catIndex, subIndex) {
            selectedAssessmentComponent.categories[catIndex].subItems.splice(subIndex, 1);
            document.getElementById(`sub-items-${catIndex}`).innerHTML = renderSubItems(catIndex);
            await saveData();
            renderAll();
        }


        // --- STUDENT LOGIC ---
        function checkAddStudentFormValidity() {
            const name = document.getElementById('new-student-real-name').value.trim();
            const id = document.getElementById('new-student-id').value.trim();
            const roll = document.getElementById('new-student-roll-number').value.trim();
            document.getElementById('add-student-button').disabled = !name || !id || !roll;
        }

        async function addStudent() {
            if (!activeCourse) return;
            const realName = document.getElementById('new-student-real-name').value.trim();
            const nickname = document.getElementById('new-student-nickname').value.trim();
            const studentId = document.getElementById('new-student-id').value.trim();
            const rollNumber = document.getElementById('new-student-roll-number').value.trim();

            if (students.some(s => s.studentId === studentId)) { showAlert('ข้อผิดพลาด', 'รหัสนักเรียนมีอยู่แล้วในระบบ กรุณาใช้รหัสที่ไม่ซ้ำกัน'); return; }
            const studentsInCurrentClass = students.filter(s => s.gradeLevel === activeCourse.gradeLevel && s.room === activeCourse.room);
            if (studentsInCurrentClass.some(s => s.rollNumber === rollNumber)) { showAlert('ข้อผิดพลาด', 'เลขที่มีอยู่แล้วสำหรับนักเรียนคนอื่นในห้องนี้'); return; }

            students.push({ realName, nickname, studentId, rollNumber, gradeLevel: activeCourse.gradeLevel, room: activeCourse.room, scores: {} });

            ['new-student-real-name', 'new-student-nickname', 'new-student-id', 'new-student-roll-number'].forEach(id => document.getElementById(id).value = '');
            checkAddStudentFormValidity();
            await saveData();
            renderStudents();
            showToast(`${realName} ถูกเพิ่มแล้ว`, 'success');
            renderAll();
        }

        function showDeleteStudentConfirmation(studentId) {
            const student = students.find(s => s.studentId === studentId);
            if (!student) return;
            showConfirmationModal(
                'ยืนยันการลบนักเรียน',
                `คุณแน่ใจหรือไม่ว่าต้องการลบนักเรียน "${student.realName}" (รหัส: ${student.studentId})? คะแนนทั้งหมดของนักเรียนนี้จะถูกลบออก การดำเนินการนี้ไม่สามารถย้อนกลับได้`,
                () => removeStudent(studentId)
            );
        }

        async function removeStudent(studentId) {
            students = students.filter(s => s.studentId !== studentId);
            try {
                await deleteDoc(doc(db, "students", studentId));
                console.log(`Student ${studentId} deleted from Firestore.`);
                showToast('นักเรียนถูกลบแล้ว', 'success');
            } catch (e) {
                console.error(`Error deleting student ${studentId} from Firestore:`, e);
                showToast('ไม่สามารถลบนักเรียนออกจากฐานข้อมูลได้', 'error');
            }
        }

        function startEditStudent(studentId) {
            if (editingStudentId) {
                showToast('กรุณาบันทึกหรือยกเลิกการแก้ไขนักเรียนปัจจุบันก่อน', 'error');
                return;
            }
            editingStudentId = studentId;
            originalStudentState = JSON.parse(JSON.stringify(students.find(s => s.studentId === studentId)));
            renderStudents();
        }

        function cancelEditStudent() {
            const studentIndex = students.findIndex(s => s.studentId === editingStudentId);
            if (studentIndex > -1) {
                students[studentIndex] = originalStudentState;
            }
            editingStudentId = null;
            originalStudentState = null;
            renderStudents();
        }

        async function saveStudentChanges(studentId) {
            const studentIndex = students.findIndex(s => s.studentId === studentId);
            if (studentIndex === -1) return;

            const studentRow = document.getElementById(`student-${studentId}`);
            const newRealName = studentRow.querySelector('.edit-student-real-name').value.trim();
            const newNickname = studentRow.querySelector('.edit-student-nickname').value.trim();
            const newRollNumber = studentRow.querySelector('.edit-student-roll-number').value.trim();

            if (!newRealName || !newRollNumber) {
                showToast('ชื่อและเลขที่ของนักเรียนต้องไม่ว่าง', 'error');
                return;
            }

            const studentsInCurrentClass = students.filter(s => s.gradeLevel === activeCourse.gradeLevel && s.room === activeCourse.room);
            if (studentsInCurrentClass.some(s => s.studentId !== studentId && s.rollNumber === newRollNumber)) {
                showToast('เลขที่นี้มีอยู่แล้วสำหรับนักเรียนคนอื่นในห้องนี้', 'error');
                return;
            }

            students[studentIndex].realName = newRealName;
            students[studentIndex].nickname = newNickname;
            students[studentIndex].rollNumber = newRollNumber;

            editingStudentId = null;
            originalStudentState = null;
            await saveData();
            renderStudents();
            showToast('อัปเดตข้อมูลนักเรียนเรียบร้อยแล้ว!', 'success');
            renderAll();
        }

        function renderStudents() {
            const container = document.getElementById('student-list');
            if (!activeCourse) { container.innerHTML = ''; return; }
            const studentsInClass = students.filter(s => s.gradeLevel === activeCourse.gradeLevel && s.room === activeCourse.room);

            if (studentsInClass.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-center p-4">ยังไม่มีนักเรียนในห้องนี้</p>';
                return;
            }

            container.innerHTML = studentsInClass.sort((a, b) => {
                const rollA = parseInt(a.rollNumber, 10);
                const rollB = parseInt(b.rollNumber, 10);
                return rollA - rollB;
            }).map(s => {
                if (editingStudentId === s.studentId) {
                    return `
                        <div id="student-${s.studentId}" class="p-2 rounded-md border-2 border-indigo-500 card space-y-2">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" value="${s.realName}" class="edit-student-real-name p-1 col-span-2" placeholder="ชื่อ-นามสกุล">
                                <input type="text" value="${s.nickname || ''}" class="edit-student-nickname p-1 col-span-2" placeholder="ชื่อเล่น">
                                <input type="text" value="${s.studentId}" class="edit-student-id p-1" placeholder="รหัสนักเรียน" disabled>
                                <input type="number" value="${s.rollNumber}" class="edit-student-roll-number p-1" placeholder="เลขที่">
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="saveStudentChanges('${s.studentId}')" class="w-full bg-green-600 text-white px-3 py-1 rounded-md text-sm">บันทึก</button>
                                <button onclick="cancelEditStudent()" class="w-full bg-slate-500 text-white px-3 py-1 rounded-md text-sm">ยกเลิก</button>
                            </div>
                        </div>`;
                } else {
                    return `
                        <div id="student-${s.studentId}" class="flex items-center gap-2 p-2 rounded-md border card hover:bg-slate-800">
                            <div class="flex-grow">
                                <p class="font-medium">${s.rollNumber}. ${s.realName} <span class="text-slate-400 text-sm">(${s.nickname || '-'})</span></p>
                                <p class="text-sm text-slate-500">รหัส: ${s.studentId} | ระดับชั้น: ${s.gradeLevel}/${s.room}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="startEditStudent('${s.studentId}')" class="bg-yellow-600 text-white px-3 py-1 rounded-md text-sm">แก้ไข</button>
                                <button onclick="showDeleteStudentConfirmation('${s.studentId}')" class="bg-red-600 text-white px-3 py-1 rounded-md text-sm">ลบ</button>
                            </div>
                        </div>`;
                }
            }).join('');
        }

        async function handleCsvImport(event) {
            if (!activeCourse) {
                showToast("กรุณาเลือกวิชาก่อนนำเข้านักเรียน", "error");
                return;
            }
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async e => {
                const lines = e.target.result.split(/\r\n|\n/).filter(line => line.trim() !== '').slice(1);
                let added = 0, updated = 0, skipped = 0;
                for (const line of lines) {
                    const [studentId, realName, nickname, rollNumber] = line.split(',').map(f => f.trim());
                    if (!studentId || !realName || !rollNumber) {
                        skipped++;
                        console.warn(`Skipping invalid student CSV row: ${line}`);
                        continue;
                    }

                    const existingIndex = students.findIndex(s => s.studentId === studentId);
                    const studentsInCurrentClass = students.filter(s => s.gradeLevel === activeCourse.gradeLevel && s.room === activeCourse.room);
                    const rollNumberExistsInCurrentClass = studentsInCurrentClass.some(s => s.studentId !== studentId && s.rollNumber === rollNumber);
                    const studentIdExistsWithDifferentRollInSameClass = students.some(s => s.studentId === studentId && s.rollNumber !== rollNumber && s.gradeLevel === activeCourse.gradeLevel && s.room === activeCourse.room);


                    if (existingIndex !== -1) {
                        if (rollNumberExistsInCurrentClass && students[existingIndex].rollNumber !== rollNumber) {
                                showToast(`นักเรียนที่มีเลขที่ ${rollNumber} มีอยู่แล้วในห้องนี้, ข้ามการอัปเดตสำหรับ ${realName} (รหัส: ${studentId})`, 'error', 5000);
                                skipped++;
                                continue;
                        }
                        const existingStudent = students[existingIndex];
                        Object.assign(existingStudent, { realName, nickname, rollNumber, gradeLevel: activeCourse.gradeLevel, room: activeCourse.room });
                        updated++;
                    } else if (rollNumberExistsInCurrentClass || studentIdExistsWithDifferentRollInSameClass) {
                        showToast(`ข้อมูลขัดแย้ง: นักเรียนที่มีเลขที่ ${rollNumber} หรือรหัส ${studentId} มีอยู่ในห้องนี้แล้ว`, 'error', 7000);
                        skipped++;
                        continue;
                    }
                    else {
                        students.push({ studentId, realName, nickname, rollNumber, gradeLevel: activeCourse.gradeLevel, room: activeCourse.room, scores: {} });
                        added++;
                    }
                }
                await saveData();
                renderStudents();
                showToast(`นำเข้าข้อมูลเรียบร้อย! เพิ่ม: ${added}, อัปเดต: ${updated}, ข้าม: ${skipped}.`, 'success');
                renderAll();
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // --- SCORE CALCULATION & RENDERING ---
        function getCategoryScores(student, componentName, category, courseToUse) {
            let current = 0;
            let max = 0;
            if (!courseToUse || !student.scores || !student.scores[courseToUse.id] || !student.scores[courseToUse.id][componentName]) {
                return { current: 0, max: 0 };
            }

            const catScores = student.scores[courseToUse.id][componentName][category.name] || {};

            if (category.subItems && category.subItems.length > 0) {
                category.subItems.forEach(sub => {
                    max += Number(sub.maxScore);
                    const subScoreValue = parseFloat(catScores[sub.id] || 0);
                    current += subScoreValue;
                });
            } else {
                max = 100;
                current = parseFloat(catScores || 0);
            }
            return { current, max };
        }

        function calculateFinalScoreAndGrade(student, course) {
            let totalWeightedCourseScore = 0;
            if (!course || !student.scores[course.id] || !course.assessmentComponents || course.assessmentComponents.length === 0) return { finalScore: '0.00', grade: 'N/A' };

            course.assessmentComponents.forEach(component => {
                let totalComponentScore = 0;
                let totalComponentMaxWeight = 0;

                if (!Array.isArray(component.categories)) {
                    return;
                }

                component.categories.forEach(cat => {
                    const { current, max } = getCategoryScores(student, component.name, cat, activeCourse);
                    if (max > 0) {
                        const categoryPercentage = (current / max);
                        totalComponentScore += categoryPercentage * cat.weight;
                    }
                    totalComponentMaxWeight += cat.weight;
                });

                if (totalComponentMaxWeight > 0) {
                    const normalizedComponentScore = (totalComponentScore / totalComponentMaxWeight) * 100;
                    totalWeightedCourseScore += (normalizedComponentScore / 100) * component.weight;
                }
            });

            const score = Math.min(totalWeightedCourseScore, 100);
            let grade = 'N/A';
            if (isNaN(score)) grade = 'N/A';
            else if (score >= 90) grade = 'A+';
            else if (score >= 85) grade = 'A';
            else if (score >= 80) grade = 'A-';
            else if (score >= 75) grade = 'B+';
            else if (score >= 70) grade = 'B';
            else if (score >= 65) grade = 'B-';
            else if (score >= 60) grade = 'C+';
            else if (score >= 55) grade = 'C';
            else if (score >= 50) grade = 'C-';
            else if (score >= 45) grade = 'D';
            else grade = 'F';

            return { finalScore: score.toFixed(2), grade };
        }

        async function updateSubScore(studentId, componentName, catName, subId, value) {
            const student = students.find(s => s.studentId === studentId);
            if (!student || !activeCourse) {
                return;
            }

            const score = parseFloat(value);
            const component = activeCourse.assessmentComponents.find(p => p.name === componentName);
            if (!component) {
                return;
            }
            const category = component.categories.find(c => c.name === catName);
            if (!category) {
                return;
            }

            let maxScore = 100;
            if (subId) {
                const subItem = category.subItems.find(s => s.id === subId);
                if (subItem) maxScore = subItem.maxScore;
                else {
                    return;
                }
            }

            if (value.trim() === '') {
                if (!student.scores[activeCourse.id]) student.scores[activeCourse.id] = {};
                if (!student.scores[activeCourse.id][componentName]) student.scores[activeCourse.id][componentName] = {};
                if (!student.scores[activeCourse.id][componentName][catName]) student.scores[activeCourse.id][componentName][catName] = {};
                if (subId) {
                    student.scores[activeCourse.id][componentName][catName][subId] = 0;
                } else {
                    student.scores[activeCourse.id][componentName][catName] = 0;
                }
            } else if (isNaN(score) || score < 0 || score > maxScore) {
                showToast(`คะแนนต้องอยู่ระหว่าง 0 และ ${formatNumber(maxScore)}.`, 'error');
                const currentInput = document.querySelector(`input[onchange*='${studentId}'][onchange*='${componentName}'][onchange*='${catName}'][onchange*='${subId || 'null'}']`);
                if (currentInput) {
                    if (subId) {
                        currentInput.value = student.scores[activeCourse.id]?.[componentName]?.[cat.name]?.[sub.id] || '';
                    } else {
                        currentInput.value = student.scores[activeCourse.id]?.[componentName]?.[cat.name] || '';
                    }
                }
                return;
            } else {
                if (!student.scores[activeCourse.id]) student.scores[activeCourse.id] = {};
                if (!student.scores[activeCourse.id][componentName]) student.scores[activeCourse.id][componentName] = {};
                if (!student.scores[activeCourse.id][componentName][catName]) student.scores[activeCourse.id][componentName][catName] = {};

                if (subId) {
                    student.scores[activeCourse.id][componentName][catName][subId] = score;
                } else {
                    student.scores[activeCourse.id][componentName][catName] = score;
                }
            }

            await saveData();
            
            const scoreTableBody = document.querySelector('#score-input-table tbody');
            let studentRow = null;
            if (scoreTableBody) {
                for (let i = 0; i < scoreTableBody.children.length; i++) {
                    const row = scoreTableBody.children[i];
                    const studentIdDiv = row.querySelector('td:first-child div.text-xs');
                    if (studentIdDiv && studentIdDiv.textContent.includes(`รหัส: ${studentId}`)) {
                        studentRow = row;
                        break;
                    }
                }
            }

            if (studentRow) {
                let currentCategoryColIndex = 0;
                let foundCategory = false;

                activeCourse.assessmentComponents.forEach(comp => {
                    comp.categories.forEach(cat => {
                        const colspan = (cat.subItems && cat.subItems.length > 0) ? cat.subItems.length + 1 : 2;
                        if (comp.name === componentName && cat.name === catName) {
                            const categoryTotalCell = studentRow.children[1 + currentCategoryColIndex + (cat.subItems?.length || 0)];
                            if (categoryTotalCell) {
                                const { current, max } = getCategoryScores(student, componentName, category, activeCourse);
                                const percentage = max > 0 ? Math.round((current / max) * 100) : 0;
                                categoryTotalCell.innerHTML = `${formatNumber(current)}<br>(${percentage}%)`;
                            }
                            foundCategory = true;
                        }
                        currentCategoryColIndex += colspan;
                    });
                    if (foundCategory) return;
                });

                const { finalScore, grade } = calculateFinalScoreAndGrade(student, activeCourse);
                const finalScoreCell = studentRow.querySelector('.final-score-cell');
                const finalGradeCell = studentRow.querySelector('.final-grade-cell');

                if (finalScoreCell && finalGradeCell) {
                    finalScoreCell.textContent = formatNumber(finalScore);
                    finalGradeCell.textContent = grade;
                }
            }
        }

        // Renders the score input table
        function renderScoresTable() {
            const container = document.getElementById('score-input-table');
            const info = document.getElementById('score-entry-info');
            if (!activeCourse || !activeCourse.assessmentComponents || activeCourse.assessmentComponents.length === 0) {
                info.textContent = 'กรุณาเพิ่มองค์ประกอบการประเมินและหมวดหมู่เพื่อเริ่มต้น';
                info.classList.remove('hidden');
                container.innerHTML = '';
                return;
            }

            const studentsInClass = students.filter(s => s.gradeLevel === activeCourse.gradeLevel && s.room === activeCourse.room);

            if (studentsInClass.length === 0) {
                info.textContent = 'กรุณาเพิ่มนักเรียนเพื่อเริ่มต้น';
                info.classList.remove('hidden');
                container.innerHTML = '';
                return;
            }

            const hasCategories = activeCourse.assessmentComponents.some(component => component.categories && component.categories.length > 0);
            if (!hasCategories) {
                info.textContent = 'กรุณาเพิ่มหมวดหมู่ในองค์ประกอบการประเมินเพื่อเริ่มต้น';
                info.classList.remove('hidden');
                container.innerHTML = '';
                return;
            }

            info.classList.add('hidden');

            let tableHTML = `<table class="min-w-full border-collapse"><thead><tr class="sticky-header">`;
            tableHTML += `<th rowspan="3" class="sticky-col p-2 border border-slate-600 text-left">นักเรียน</th>`;

            activeCourse.assessmentComponents.forEach((component, componentIndex) => {
                const totalCategoriesInComponent = component.categories.reduce((sum, cat) => sum + (cat.subItems && cat.subItems.length > 0 ? cat.subItems.length + 1 : 2), 0);
                if (totalCategoriesInComponent > 0) {
                    tableHTML += `<th colspan="${totalCategoriesInComponent}" class="p-2 border border-slate-600 text-center" style="background-color: ${tableHeaderColors[componentIndex % tableHeaderColors.length]}">${component.name} (${component.weight}%)</th>`;
                }
            });
            tableHTML += `<th rowspan="3" class="p-2 border border-slate-600">คะแนนสุดท้าย</th><th rowspan="3" class="p-2 border border-slate-600">เกรดสุดท้าย</th></tr>`;

            tableHTML += `<tr class="sticky-header">`;
            activeCourse.assessmentComponents.forEach((component, componentIndex) => {
                component.categories.forEach((cat, catIndex) => {
                    const colspan = (cat.subItems && cat.subItems.length > 0) ? cat.subItems.length + 1 : 2;
                    tableHTML += `<th colspan="${colspan}" class="p-2 border border-slate-600 text-center" style="background-color: ${tableHeaderColors[componentIndex % tableHeaderColors.length]}">${cat.name} (${cat.weight}%)</th>`;
                });
            });
            tableHTML += `</tr>`;

            tableHTML += `<tr class="sticky-header">`;
            activeCourse.assessmentComponents.forEach((component, componentIndex) => {
                component.categories.forEach((cat, catIndex) => {
                    if (cat.subItems && cat.subItems.length > 0) {
                        cat.subItems.forEach(sub => tableHTML += `<th class="p-2 border border-slate-600 text-center font-normal" style="background-color: ${tableHeaderColors[componentIndex % tableHeaderColors.length]}">${sub.name} (${formatNumber(sub.maxScore)})</th>`);
                        tableHTML += `<th class="p-2 border border-slate-600 text-center font-medium category-total-header" style="background-color: ${tableHeaderColors[componentIndex % tableHeaderColors.length]}">รวม</th>`;
                    } else {
                        tableHTML += `<th class="p-2 border border-slate-600 text-center font-normal" style="background-color: ${tableHeaderColors[componentIndex % tableHeaderColors.length]}">คะแนน (${formatNumber(100)})</th>`;
                        tableHTML += `<th class="p-2 border border-slate-600 text-center font-medium category-total-header" style="background-color: ${tableHeaderColors[componentIndex % tableHeaderColors.length]}">รวม</th>`;
                    }
                });
            });
            tableHTML += `</tr></thead><tbody>`;

            studentsInClass.sort((a, b) => parseInt(a.rollNumber, 10) - parseInt(b.rollNumber, 10)).forEach(s => {
                const { finalScore, grade } = calculateFinalScoreAndGrade(s, activeCourse);
                tableHTML += `<tr class="hover:bg-slate-800"><td class="sticky-col p-2 border border-slate-600 text-left font-medium">
                                        <div>${s.rollNumber}. ${s.realName} <span class="text-slate-400 text-sm">(${s.nickname || '-'})</span></div>
                                        <div class="text-xs text-slate-400 font-normal">รหัส: ${s.studentId} | ระดับชั้น: ${s.gradeLevel}/${s.room}</div>
                                    </td>`;
                activeCourse.assessmentComponents.forEach(component => {
                    component.categories.forEach(cat => {
                        const catScores = getCategoryScores(s, component.name, cat, activeCourse);
                        const categoryPercentage = (catScores.max > 0 ? (catScores.current / catScores.max) * 100 : 0);

                        if (cat.subItems && cat.subItems.length > 0) {
                            cat.subItems.forEach(sub => {
                                const subScore = s.scores[activeCourse.id]?.[component.name]?.[cat.name]?.[sub.id] || '';
                                tableHTML += `<td class="p-1 border border-slate-600"><input type="number" class="w-full p-1 text-center score-input bg-slate-800" value="${subScore}" onchange="updateSubScore('${s.studentId}', '${component.name}', '${cat.name}', '${sub.id}', this.value)" min="0" max="${sub.maxScore}"></td>`;
                            });
                            tableHTML += `<td class="p-2 border border-slate-600 text-center font-medium category-total-cell">
                                        ${formatNumber(catScores.current)}<br>(${Math.round(categoryPercentage)}%)
                                    </td>`;
                        } else {
                            const score = s.scores[activeCourse.id]?.[component.name]?.[cat.name] || '';
                            const currentScore = parseFloat(score || 0);
                            const singleCategoryPercentage = (100 > 0 ? (currentScore / 100) * 100 : 0);
                            tableHTML += `<td class="p-1 border border-slate-600"><input type="number" class="w-full p-1 text-center score-input bg-slate-800" value="${score}" onchange="updateSubScore('${s.studentId}', '${component.name}', '${cat.name}', null, this.value)" min="0" max="100"></td>`;
                            tableHTML += `<td class="p-2 border border-slate-600 text-center font-medium category-total-cell">
                                        ${formatNumber(currentScore)}<br>(${Math.round(singleCategoryPercentage)}%)
                                    </td>`;
                        }
                    });
                });
                tableHTML += `<td class="p-2 border border-slate-600 text-center font-bold final-score-cell">${formatNumber(finalScore)}</td><td class="p-2 border border-slate-600 text-center font-bold final-grade-cell">${grade}</td></tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        // --- SUMMARY & REPORTS ---
        function renderSummary() {
            const container = document.getElementById('summary-table');
            const info = document.getElementById('summary-info');
            if (!activeCourse || !activeCourse.assessmentComponents || activeCourse.assessmentComponents.length === 0) {
                info.textContent = 'กรุณากรอกคะแนนเพื่อดูรายงานสรุป';
                info.classList.remove('hidden');
                container.innerHTML = '';
                document.getElementById('advanced-dashboard').classList.add('hidden');
                return;
            }

            const studentsInClass = students.filter(s => s.gradeLevel === activeCourse.gradeLevel && s.room === activeCourse.room);

            if (studentsInClass.length === 0) {
                info.textContent = 'กรุณากรอกคะแนนเพื่อดูรายงานสรุป';
                info.classList.remove('hidden');
                container.innerHTML = '';
                document.getElementById('advanced-dashboard').classList.add('hidden');
                return;
            }

            const hasCategories = activeCourse.assessmentComponents.some(component => component.categories && component.categories.length > 0);
            if (!hasCategories) {
                info.textContent = 'กรุณาเพิ่มหมวดหมู่ในองค์ประกอบการประเมินเพื่อดูรายงานสรุป';
                info.classList.remove('hidden');
                container.innerHTML = '';
                document.getElementById('advanced-dashboard').classList.add('hidden');
                return;
            }

            info.classList.add('hidden');
            document.getElementById('advanced-dashboard').classList.remove('hidden');

            let tableHTML = `<table class="min-w-full"><thead><tr>
                        <th class="p-2 border border-slate-600 text-left">นักเรียน</th>`;
            activeCourse.assessmentComponents.forEach((component, i) => {
                tableHTML += `<th class="p-2 border border-slate-600 text-center" style="background-color: ${tableHeaderColors[i % tableHeaderColors.length]}">${component.name} (%)</th>`;
            });
            tableHTML += `<th class="p-2 border border-slate-600">คะแนนสุดท้าย</th><th class="p-2 border border-slate-600">เกรดสุดท้าย</th></tr></thead><tbody>`;

            studentsInClass.sort((a,b) => parseFloat(calculateFinalScoreAndGrade(b, activeCourse).finalScore) - parseFloat(calculateFinalScoreAndGrade(a, activeCourse).finalScore)).forEach(s => {
                const { finalScore, grade } = calculateFinalScoreAndGrade(s, activeCourse);
                let rowBgClass = '';
                let detailsButtonText = 'ดูรายละเอียด';
                let detailsButtonClass = 'bg-indigo-700 hover:bg-indigo-600';

                if (parseFloat(finalScore) >= 70) {
                    rowBgClass = 'bg-green-900/20';
                    detailsButtonText = 'รายละเอียด (ยอดเยี่ยม)';
                    detailsButtonClass = 'bg-green-800 hover:bg-green-700';
                } else if (parseFloat(finalScore) >= 50) {
                    rowBgClass = 'bg-yellow-900/20';
                    detailsButtonText = 'รายละเอียด (ปานกลาง)';
                    detailsButtonClass = 'bg-yellow-800 hover:bg-yellow-700';
                } else {
                    rowBgClass = 'bg-red-900/20';
                    detailsButtonText = 'รายละเอียด (ต้องปรับปรุง)';
                    detailsButtonClass = 'bg-red-800 hover:bg-red-700';
                }

                tableHTML += `<tr class="${rowBgClass}"><td class="p-2 border border-slate-600 font-medium">
                                        <div>${s.rollNumber}. ${s.realName} <span class="text-slate-400 text-sm">(${s.nickname || '-'})</span></div>
                                        <div class="text-xs text-slate-400 font-normal">รหัส: ${s.studentId}</div>
                                        <button onclick="showScoreBreakdownModal('${s.studentId}')" class="mt-1 text-xs ${detailsButtonClass} px-2 py-1 rounded transition-colors">${detailsButtonText}</button>
                                    </td>`;
                activeCourse.assessmentComponents.forEach(component => {
                    let componentCurrentScore = 0;
                    let componentMaxWeight = 0;
                    if (!Array.isArray(component.categories)) {
                        tableHTML += `<td class="p-2 border border-slate-600 text-center">N/A</td>`;
                        return;
                    }
                    component.categories.forEach(cat => {
                        const { current, max } = getCategoryScores(s, component.name, cat, activeCourse);
                        if (max > 0) {
                            componentCurrentScore += (current / max) * cat.weight;
                        }
                        componentMaxWeight += cat.weight;
                    });
                    const componentPercentage = componentMaxWeight > 0 ? (componentCurrentScore / componentMaxWeight) * 100 : 0;
                    tableHTML += `<td class="p-2 border border-slate-600 text-center">${formatNumber(componentPercentage)}%</td>`;
                });
                tableHTML += `<td class="p-2 border border-slate-600 text-center font-bold">${formatNumber(finalScore)}</td><td class="p-2 border border-slate-600 text-center font-bold">${grade}</td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;

            renderAdvancedDashboard(studentsInClass);
        }

        function renderAdvancedDashboard(studentsInClass) {
            const excellentUl = document.getElementById('group-excellent');
            const averageUl = document.getElementById('group-average');
            const improvementUl = document.getElementById('group-improvement');
            excellentUl.innerHTML = averageUl.innerHTML = improvementUl.innerHTML = '';

            let counts = { excellent: 0, average: 0, improvement: 0 };

            studentsInClass.forEach(s => {
                const { finalScore } = calculateFinalScoreAndGrade(s, activeCourse);
                const score = parseFloat(finalScore);
                const li = document.createElement('li');
                li.textContent = `${s.realName} (${formatNumber(score)}%)`;
                if (score >= 70) {
                    excellentUl.appendChild(li);
                    counts.excellent++;
                } else if (score >= 50) {
                    averageUl.appendChild(li);
                    counts.average++;
                } else {
                    improvementUl.appendChild(li);
                    counts.improvement++;
                }
            });

            const ctx = document.getElementById('student-group-chart').getContext('2d');
            if (studentGroupChartInstance) studentGroupChartInstance.destroy();
            studentGroupChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['ยอดเยี่ยม', 'ปานกลาง', 'ต้องปรับปรุง'],
                    datasets: [{
                        data: [counts.excellent, counts.average, counts.improvement],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e2e8f0'
                            }
                        }
                    }
                }
            });
        }

        function renderAdminDashboard() {
            const dashboardContent = document.getElementById('admin-dashboard-content');
            dashboardContent.innerHTML = '';

            if (courses.length === 0) {
                dashboardContent.innerHTML = '<p class="text-slate-400 text-center text-lg mt-8">ไม่มีข้อมูลวิชา</p>';
                return;
            }

            let totalPossibleEntriesOverall = 0;
            let filledEntriesOverall = 0;

            courses.forEach(course => {
                const studentsInThisCourse = students.filter(s => s.gradeLevel === course.gradeLevel && s.room === course.room);
                let courseTotalPossibleEntries = 0;
                let courseFilledEntries = 0;

                if (course.assessmentComponents && course.assessmentComponents.length > 0) {
                    studentsInThisCourse.forEach(s => {
                        course.assessmentComponents.forEach(component => {
                            if (component.categories && component.categories.length > 0) {
                                component.categories.forEach(cat => {
                                    if (cat.subItems && cat.subItems.length > 0) {
                                        cat.subItems.forEach(sub => {
                                            courseTotalPossibleEntries++;
                                            if (s.scores[course.id]?.[component.name]?.[cat.name]?.[sub.id] !== undefined && s.scores[course.id]?.[component.name]?.[cat.name]?.[sub.id] !== null && !isNaN(s.scores[course.id]?.[component.name]?.[cat.name]?.[sub.id])) {
                                                courseFilledEntries++;
                                            }
                                        });
                                    } else {
                                        courseTotalPossibleEntries++;
                                        if (s.scores[course.id]?.[component.name]?.[cat.name] !== undefined && s.scores[course.id]?.[component.name]?.[cat.name] !== null && !isNaN(s.scores[course.id]?.[component.name]?.[cat.name])) {
                                            courseFilledEntries++;
                                        }
                                    }
                                });
                            }
                        });
                    });
                }
                totalPossibleEntriesOverall += courseTotalPossibleEntries;
                filledEntriesOverall += courseFilledEntries;

                const courseName = `${course.subject} (${course.gradeLevel}/${course.room}) - ${course.academicYear} ${course.semester}`;
                const teacherName = course.teacher.realName || 'N/A';
                let totalCourseScore = 0, gradedStudentsCount = 0, highestScoreInClass = 0, lowestScoreInClass = 100;
                let gradeCounts = { 'A+': 0, 'A': 0, 'A-': 0, 'B+': 0, 'B': 0, 'B-': 0, 'C+': 0, 'C': 0, 'C-': 0, 'D': 0, 'F': 0, 'N/A': 0 };

                studentsInThisCourse.forEach(s => {
                    const { finalScore, grade } = calculateFinalScoreAndGrade(s, course);
                    const score = parseFloat(finalScore);
                    if (grade !== 'N/A' && !isNaN(score)) {
                        totalCourseScore += score;
                        gradedStudentsCount++;
                        if(gradeCounts[grade] !== undefined) gradeCounts[grade]++;
                        if (score > highestScoreInClass) highestScoreInClass = score;
                        if (score < lowestScoreInClass) lowestScoreInClass = score;
                    } else {
                        gradeCounts['N/A']++;
                    }
                });

                const averageCourseScore = gradedStudentsCount > 0 ? (totalCourseScore / gradedStudentsCount) : 'N/A';
                const displayHighestScore = gradedStudentsCount > 0 ? formatNumber(highestScoreInClass) : 'N/A';
                const displayLowestScore = gradedStudentsCount > 0 ? formatNumber(lowestScoreInClass) : 'N/A';
                const scoreEntryProgress = courseTotalPossibleEntries > 0 ? (courseFilledEntries / courseTotalPossibleEntries) * 100 : 0;


                dashboardContent.innerHTML += `
                    <div class="p-6 rounded-lg border card">
                        <h4 class="text-xl font-semibold mb-2 text-blue-300">${courseName}</h4>
                        <p class="text-slate-400 mb-4">ครูผู้สอน: ${teacherName}</p>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                            <div><p class="text-sm text-slate-400">นักเรียน</p><p class="text-2xl font-bold text-white">${studentsInThisCourse.length}</p></div>
                            <div><p class="text-sm text-slate-400">คะแนนเฉลี่ย</p><p class="text-lg font-bold">${formatNumber(averageCourseScore)}%</p></div>
                            <div><p class="text-sm text-blue-300">สูงสุด</p><p class="text-lg font-bold">${displayHighestScore}%</p></div>
                            <div><p class="text-sm text-purple-300">ต่ำสุด</p><p class="text-lg font-bold">${displayLowestScore}%</p></div>
                            <div class="col-span-full mt-2">
                                <p class="text-sm text-slate-400">ความคืบหน้าการกรอกคะแนน</p>
                                <div class="w-full bg-slate-700 rounded-full h-3">
                                    <div class="bg-indigo-500 h-3 rounded-full" style="width: ${scoreEntryProgress}%"></div>
                                </div>
                                <p class="text-right text-xs text-slate-400 mt-1">${Math.round(scoreEntryProgress)}% สมบูรณ์</p>
                            </div>
                        </div>
                        <div class="mt-4 space-y-2">
                            <details class="p-2 bg-green-900/50 rounded-lg">
                                <summary class="font-bold text-green-300 cursor-pointer flex justify-between items-center">
                                    นักเรียนยอดเยี่ยม (${gradeCounts['A+'] + gradeCounts['A'] + gradeCounts['A-'] + gradeCounts['B+'] + gradeCounts['B']}) <span class="summary-arrow">▶</span>
                                </summary>
                                <ul class="mt-2 text-sm text-green-400 list-disc list-inside">
                                    ${studentsInThisCourse.filter(s => parseFloat(calculateFinalScoreAndGrade(s, course).finalScore) >= 70).map(s => `<li>${s.realName} (${formatNumber(calculateFinalScoreAndGrade(s, course).finalScore)}%)</li>`).join('')}
                                </ul>
                            </details>
                            <details class="p-2 bg-yellow-900/50 rounded-lg">
                                <summary class="font-bold text-yellow-300 cursor-pointer flex justify-between items-center">
                                    นักเรียนปานกลาง (${gradeCounts['C+'] + gradeCounts['C'] + gradeCounts['C-'] + gradeCounts['B-']}) <span class="summary-arrow">▶</span>
                                </summary>
                                <ul class="mt-2 text-sm text-yellow-400 list-disc list-inside">
                                    ${studentsInThisCourse.filter(s => parseFloat(calculateFinalScoreAndGrade(s, course).finalScore) >= 50 && parseFloat(calculateFinalScoreAndGrade(s, course).finalScore) < 70).map(s => `<li>${s.realName} (${formatNumber(calculateFinalScoreAndGrade(s, course).finalScore)}%)</li>`).join('')}
                                </ul>
                            </details>
                            <details class="p-2 bg-red-900/50 rounded-lg">
                                <summary class="font-bold text-red-300 cursor-pointer flex justify-between items-center">
                                    นักเรียนที่ต้องปรับปรุง (${gradeCounts['D'] + gradeCounts['F'] + gradeCounts['N/A']}) <span class="summary-arrow">▶</span>
                                </summary>
                                <ul class="mt-2 text-sm text-red-400 list-disc list-inside">
                                    ${studentsInThisCourse.filter(s => parseFloat(calculateFinalScoreAndGrade(s, course).finalScore) < 50 || isNaN(parseFloat(calculateFinalScoreAndGrade(s, course).finalScore))).map(s => `<li>${s.realName} (${formatNumber(calculateFinalScoreAndGrade(s, course).finalScore)}%)</li>`).join('')}
                                </ul>
                            </details>
                        </div>
                    </div>`;
            });

            const overallScoreEntryProgress = totalPossibleEntriesOverall > 0 ? (filledEntriesOverall / totalPossibleEntriesOverall) * 100 : 0;

            dashboardContent.insertAdjacentHTML('afterbegin', `
                <div class="mb-8 p-6 rounded-lg border card">
                    <h4 class="text-xl font-semibold mb-4 text-indigo-300">ภาพรวมทั้งโรงเรียน</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div><p class="text-sm text-slate-400">จำนวนวิชา</p><p class="text-2xl font-bold text-white">${courses.length}</p></div>
                        <div><p class="text-sm text-slate-400">จำนวนนักเรียน</p><p class="text-2xl font-bold text-white">${students.length}</p></div>
                        <div><p class="text-sm text-slate-400">ครูผู้สอนที่ใช้งาน</p><p class="text-2xl font-bold text-white">${new Set(courses.map(c => c.teacher.realName).filter(name => name)).size}</p></div>
                    </div>
                    <div class="mt-6">
                        <h5 class="font-semibold text-lg mb-2">ความคืบหน้าการกรอกคะแนนรวม</h5>
                        <div class="w-full bg-slate-700 rounded-full h-4">
                            <div class="bg-indigo-500 h-4 rounded-full" style="width: ${overallScoreEntryProgress}%"></div>
                        </div>
                        <p class="text-right text-sm text-slate-400 mt-1">${Math.round(overallScoreEntryProgress)}% สมบูรณ์</p>
                    </div>
                </div>
            `);
        }


        // --- TABS & MAIN RENDER ---
        function showTab(tabName) {
            document.getElementById('score-entry-section').classList.toggle('hidden', tabName !== 'score-entry');
            document.getElementById('summary-section').classList.toggle('hidden', tabName !== 'summary');
            document.getElementById('score-entry-tab').classList.toggle('active', tabName === 'score-entry');
            document.getElementById('summary-tab').classList.toggle('active', tabName === 'summary');
            renderAll();
        }

        function renderAll() {
            if (!activeCourse) {
                document.getElementById('grading-period-list').innerHTML = '';
                document.getElementById('select-grading-period').innerHTML = '<option value="">เลือกองค์ประกอบการประเมิน</option>';
                document.getElementById('selected-grading-period-status').classList.add('hidden');
                document.getElementById('current-period-name').textContent = 'องค์ประกอบที่เลือก';
                selectedAssessmentComponent = null;

                document.getElementById('category-settings').innerHTML = '';
                document.getElementById('student-list').innerHTML = '';
                document.getElementById('score-input-table').innerHTML = '';
                document.getElementById('summary-table').innerHTML = '';

                document.getElementById('score-entry-info').textContent = 'กรุณาเลือก ปีการศึกษา, ภาคเรียน, วิชา, และบันทึกข้อมูลครูผู้สอนเพื่อเริ่มต้น';
                document.getElementById('summary-info').textContent = 'ไม่มีข้อมูลให้แสดง';
                document.getElementById('score-entry-info').classList.remove('hidden');
                document.getElementById('summary-info').classList.remove('hidden');

                if (studentGroupChartInstance) studentGroupChartInstance.destroy();
                document.getElementById('advanced-dashboard').classList.add('hidden');

                const totalCompWeightSpan = document.getElementById('current-total-grading-period-weight');
                const compWarningDiv = document.getElementById('grading-period-warning');
                if (totalCompWeightSpan) totalCompWeightSpan.textContent = '0';
                if (compWarningDiv) compWarningDiv.classList.add('hidden');

                const totalCatWeightSpan = document.getElementById('current-total-category-weight');
                const catWarningDiv = document.getElementById('category-weight-warning');
                if (totalCatWeightSpan) totalCatWeightSpan.textContent = '0';
                if (catWarningDiv) catWarningDiv.classList.add('hidden');

                renderTeacherInfoSection();
                updateCategoryManagementSectionState();
                return;
            }

            renderCategories();
            renderStudents();
            renderTeacherInfoSection();
            renderAssessmentComponents();
            updateCategoryManagementSectionState();

            const activeTab = document.querySelector('.tab-button.active').id;
            if (activeTab === 'summary-tab') {
                renderSummary();
            } else {
                renderScoresTable();
            }
        }

        // --- EVENT LISTENERS & SETUP ---
        function setupEventListeners() {
            document.getElementById('select-academic-year').addEventListener('change', updateAcademicYearSelection);
            document.getElementById('select-semester').addEventListener('change', updateSemesterSelection);

            document.getElementById('new-grading-period-name').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') addGradingPeriod();
            });
            document.getElementById('new-grading-period-weight').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') addGradingPeriod();
            });

            document.getElementById('new-category-name').addEventListener('keydown', (e) => {
                if(e.key === 'Enter') addCategory();
            });
            document.getElementById('new-category-weight').addEventListener('keydown', (e) => {
                if(e.key === 'Enter') addCategory();
            });

            document.getElementById('category-management-section').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.id.startsWith('new-sub-item-name-')) {
                    const catIndex = parseInt(e.target.id.replace('new-sub-item-name-', ''));
                    addSubItem(catIndex);
                } else if (e.key === 'Enter' && e.target.id.startsWith('new-sub-item-max-score-')) {
                    const catIndex = parseInt(e.target.id.replace('new-sub-item-max-score-', ''));
                    addSubItem(catIndex);
                }
            });

            document.querySelectorAll('.new-student-input').forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter' && !document.getElementById('add-student-button').disabled) {
                        addStudent();
                    }
                });
            });

            document.querySelectorAll('.teacher-info-input').forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter' && !document.getElementById('save-teacher-info-button').disabled) {
                        saveTeacherInfo();
                    }
                });
            });

            document.getElementById('score-input-table').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.classList.contains('score-input')) {
                    e.preventDefault();
                    const inputs = Array.from(document.querySelectorAll('.score-input'));
                    const currentIndex = inputs.indexOf(e.target);
                    const nextInput = inputs[currentIndex + 1];
                    if (nextInput) {
                        nextInput.focus();
                        nextInput.select();
                    }
                }
            });

            document.getElementById('admin-password-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    checkAdminPassword();
                }
            });

            document.getElementById('reset-password-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    confirmResetCourse();
                }
            });

            document.getElementById('settings-logo-url').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveSettings();
                }
            });
        }

        // --- PAGE LOAD ---
        window.onload = async function() {
            setupEventListeners();
            await loadData();
        };
    </script>
</body>
</html>
